<?php
/**
 * Gratis gave-kampanjer for WooCommerce (én fil / code snippet)
 * Version: 1.0.0
 * Støttede checkout-moduser for fallback: klassisk checkout (støttet), Checkout Blocks (ikke støttet i denne versjonen).
 *
 * Bruk:
 * - Legg inn i Code Snippets (Run everywhere) eller child theme functions.php
 * - Gå til WooCommerce -> Gratis gave-kampanjer
 *
 * OBS:
 * - Dette er en robust MVP med fokus på ytelse og server-side validering.
 * - Test alltid i staging før produksjon.
 * - Standardregel: gave-linjer (_ggw_is_gift=1) ekskluderes fra relevante summer
 *   (fraktpakker, fri-frakt terskel, og kupongers produktvalidering).
 * - Unntak kan styres via filter: ggw_exclude_gift_from_sum.
 */

if (!defined('ABSPATH')) { exit; }
if (!class_exists('WooCommerce')) { return; }

if (!class_exists('GGW_Free_Gift_Campaigns')):
final class GGW_Free_Gift_Campaigns {
    const OPT_KEY = 'ggw_campaigns_v1';
    const NONCE_ACTION = 'ggw_campaigns_save';
    const TRANSIENT_CAMPAIGN_BY_PRODUCT = 'ggw_campaign_by_product_';
    const OPTION_USAGE_CACHE_VERSION = 'ggw_usage_cache_version';
    const VERSION = '1.0.0';
    const COUPON_GIFT_PRIORITY = 'gift_over_coupon';

    public static function init() {
        // Admin
        add_action('admin_menu', [__CLASS__, 'admin_menu']);
        add_action('admin_init', [__CLASS__, 'handle_admin_post']);
        add_action('admin_enqueue_scripts', [__CLASS__, 'enqueue_admin_assets']);

        // Product page UX
        add_action('woocommerce_before_add_to_cart_button', [__CLASS__, 'render_product_gift_ui']);
        add_filter('woocommerce_add_to_cart_validation', [__CLASS__, 'validate_add_to_cart'], 10, 5);
        add_filter('woocommerce_add_cart_item_data', [__CLASS__, 'capture_add_cart_data'], 10, 4);

        // Cart synchronization + pricing
        add_action('woocommerce_before_calculate_totals', [__CLASS__, 'sync_cart_gifts'], 20);
        add_action('woocommerce_cart_loaded_from_session', [__CLASS__, 'mark_session_loaded']);
        add_filter('woocommerce_get_cart_item_from_session', [__CLASS__, 'restore_gift_cart_item_data'], 20, 2);
        add_filter('woocommerce_cart_item_name', [__CLASS__, 'label_gift_cart_item'], 10, 3);
        add_filter('woocommerce_get_item_data', [__CLASS__, 'display_cart_item_meta'], 10, 2);
        add_action('woocommerce_remove_cart_item', [__CLASS__, 'cleanup_removed_trigger'], 10, 2);
        add_filter('woocommerce_cart_shipping_packages', [__CLASS__, 'filter_shipping_packages'], 20);
        add_filter('woocommerce_shipping_free_shipping_is_available', [__CLASS__, 'filter_free_shipping_availability'], 20, 3);
        add_filter('woocommerce_coupon_is_valid_for_product', [__CLASS__, 'exclude_gifts_from_coupon_product_validation'], 20, 4);
        add_action('woocommerce_before_cart', [__CLASS__, 'render_cart_status_line'], 5);
        add_action('template_redirect', [__CLASS__, 'maybe_handle_swap_gift_action']);
        add_action('wp_footer', [__CLASS__, 'render_swap_gift_modal_assets']);

        // Checkout fallback (støttes kun i klassisk checkout)
        self::register_checkout_fallback_hooks();

        // Order metadata
        add_action('woocommerce_checkout_create_order_line_item', [__CLASS__, 'add_order_line_meta'], 10, 4);
        add_action('woocommerce_checkout_create_order', [__CLASS__, 'add_order_coupon_conflict_meta'], 20, 2);

        // Tiny cache invalidation signal
        add_action('save_post_product', [__CLASS__, 'soft_invalidate_cache']);
        add_action('edited_product_cat', [__CLASS__, 'soft_invalidate_cache']);
        add_action('edited_product_tag', [__CLASS__, 'soft_invalidate_cache']);

        // Usage-cache invalidation for limits per customer
        add_action('woocommerce_order_status_changed', [__CLASS__, 'maybe_invalidate_usage_cache_on_status_change'], 10, 4);
    }

    private static function register_checkout_fallback_hooks() {
        if (!self::checkout_fallback_is_supported()) {
            return;
        }

        add_action('woocommerce_review_order_before_payment', [__CLASS__, 'render_checkout_fallback']);
        add_action('woocommerce_checkout_process', [__CLASS__, 'checkout_validate_fallback_choice']);
        add_action('woocommerce_checkout_process', [__CLASS__, 'checkout_apply_fallback_choice'], 20);
        add_action('woocommerce_checkout_update_order_meta', [__CLASS__, 'checkout_audit_fallback_choice']);
    }

    private static function checkout_fallback_is_supported() {
        return self::get_checkout_mode() === 'classic';
    }

    private static function get_checkout_mode() {
        $checkout_page_id = absint(get_option('woocommerce_checkout_page_id'));
        if (!$checkout_page_id) {
            return 'classic';
        }

        if (function_exists('has_block') && has_block('woocommerce/checkout', $checkout_page_id)) {
            return 'blocks';
        }

        return 'classic';
    }

    private static function get_checkout_mode_label() {
        return self::get_checkout_mode() === 'blocks' ? 'Checkout Blocks' : 'Klassisk checkout';
    }

    /* =========================
     * ADMIN
     * ========================= */
    public static function admin_menu() {
        add_submenu_page(
            'woocommerce',
            'Gratis gave-kampanjer',
            'Gratis gave-kampanjer',
            'manage_woocommerce',
            'ggw-free-gifts',
            [__CLASS__, 'render_admin_page']
        );
    }

    public static function get_campaigns() {
        $rows = get_option(self::OPT_KEY, []);
        if (!is_array($rows)) return [];
        // normalize + sort by priority desc
        foreach ($rows as &$c) {
            $c = self::normalize_campaign($c);
        }
        usort($rows, function($a, $b){
            return intval($b['priority']) <=> intval($a['priority']);
        });
        return $rows;
    }

    private static function normalize_campaign($c) {
        $defaults = [
            'id' => wp_generate_uuid4(),
            'title' => '',
            'active' => 1,
            'priority' => 10,
            'start' => '',
            'end' => '',
            'trigger_products' => [],
            'trigger_categories' => [],
            'trigger_tags' => [],
            'min_qty' => 1,
            'min_subtotal' => 0,
            'exclude_sale' => 0,
            'gift_products' => [],
            'gift_product_limits' => [],
            'gifts_to_choose' => 1,
            'gift_chooser_mode' => 'classic',
            'progressive_slides' => [],
            'max_gifts_per_order' => 1,
            'max_per_customer' => 0,
            'require_choice' => 1,
            'auto_gift' => 0,
            'headline' => 'Velg din gratis gave',
            'description' => 'Legg i handlekurv. Velg gave. Kjøp trygt ✨',
            'badge' => 'Fordel inkludert',
            'cta' => 'Velg gave',
            'gift_image_layout' => 'compact',
            'gift_image_custom_min_width' => 120,
            'gift_image_custom_aspect_ratio' => '1/1',
            'gift_image_custom_max_grid_width' => 560,
            'gift_image_shape' => 'square',
            'gift_image_custom_object_fit' => 'cover',
        ];
        $c = wp_parse_args($c, $defaults);

        foreach (['trigger_products','trigger_categories','trigger_tags','gift_products'] as $k) {
            if (!is_array($c[$k])) $c[$k] = [];
            $c[$k] = array_values(array_filter(array_map('absint', $c[$k])));
        }

        $normalized_limits = [];
        if (!is_array($c['gift_product_limits'])) {
            $c['gift_product_limits'] = [];
        }
        foreach ($c['gift_product_limits'] as $gift_id => $max_qty) {
            $gift_id = absint($gift_id);
            if (!$gift_id || !in_array($gift_id, $c['gift_products'], true)) continue;
            $normalized_limits[$gift_id] = max(0, intval($max_qty));
        }
        $c['gift_product_limits'] = $normalized_limits;

        $c['active'] = !empty($c['active']) ? 1 : 0;
        $c['exclude_sale'] = !empty($c['exclude_sale']) ? 1 : 0;
        $c['require_choice'] = !empty($c['require_choice']) ? 1 : 0;
        $c['auto_gift'] = !empty($c['auto_gift']) ? 1 : 0;
        $c['priority'] = intval($c['priority']);
        $c['min_qty'] = max(1, intval($c['min_qty']));
        $c['gifts_to_choose'] = max(1, intval($c['gifts_to_choose']));
        $c['gift_chooser_mode'] = self::sanitize_gift_chooser_mode($c['gift_chooser_mode'] ?? 'classic');
        $c['progressive_slides'] = self::normalize_progressive_slides($c['progressive_slides'] ?? [], $c['gift_products']);
        if ($c['gift_chooser_mode'] === 'progressive' && empty($c['progressive_slides'])) {
            $c['gift_chooser_mode'] = 'classic';
        }
        $c['max_gifts_per_order'] = max(1, intval($c['max_gifts_per_order']));
        $c['max_per_customer'] = max(0, intval($c['max_per_customer']));
        $c['min_subtotal'] = max(0, floatval($c['min_subtotal']));

        $c['gift_image_layout'] = self::sanitize_gift_image_layout($c['gift_image_layout'] ?? 'compact');
        $c['gift_image_custom_min_width'] = max(80, min(260, intval($c['gift_image_custom_min_width'] ?? 120)));
        $c['gift_image_custom_max_grid_width'] = max(320, min(1200, intval($c['gift_image_custom_max_grid_width'] ?? 560)));
        $c['gift_image_custom_aspect_ratio'] = self::sanitize_gift_image_aspect_ratio($c['gift_image_custom_aspect_ratio'] ?? '1/1');
        $c['gift_image_shape'] = self::sanitize_gift_image_shape($c['gift_image_shape'] ?? 'square');
        $c['gift_image_custom_object_fit'] = self::sanitize_gift_image_object_fit($c['gift_image_custom_object_fit'] ?? 'cover');

        return $c;
    }

    private static function sanitize_gift_chooser_mode($mode) {
        $allowed = ['classic', 'progressive'];
        $mode = sanitize_key($mode);
        return in_array($mode, $allowed, true) ? $mode : 'classic';
    }

    private static function normalize_progressive_slides($slides, $gift_pool_ids) {
        if (is_string($slides)) {
            $decoded = json_decode(wp_unslash($slides), true);
            $slides = is_array($decoded) ? $decoded : [];
        }
        if (!is_array($slides)) {
            return [];
        }

        $allowed_ids = array_fill_keys(array_values(array_filter(array_map('absint', (array) $gift_pool_ids))), true);
        if (empty($allowed_ids)) {
            return [];
        }

        $normalized = [];
        foreach ($slides as $slide) {
            if (!is_array($slide)) {
                continue;
            }

            $raw_ids = $slide['gift_ids'] ?? ($slide['gift_products'] ?? []);
            if (!is_array($raw_ids)) {
                $raw_ids = preg_split('/[\s,]+/', sanitize_text_field((string) $raw_ids));
            }

            $ids = [];
            foreach ((array) $raw_ids as $id) {
                $id = absint($id);
                if (!$id || empty($allowed_ids[$id]) || in_array($id, $ids, true)) {
                    continue;
                }
                $ids[] = $id;
            }
            if (empty($ids)) {
                continue;
            }

            $normalized_slide = ['gift_ids' => $ids];
            if (isset($slide['meta']) && is_array($slide['meta'])) {
                $meta = [];
                foreach ($slide['meta'] as $meta_key => $meta_value) {
                    $meta_key = sanitize_key($meta_key);
                    if ($meta_key === '') {
                        continue;
                    }
                    if (is_scalar($meta_value)) {
                        $meta[$meta_key] = sanitize_text_field((string) $meta_value);
                    }
                }
                if (!empty($meta)) {
                    $normalized_slide['meta'] = $meta;
                }
            }

            $normalized[] = $normalized_slide;
        }

        return $normalized;
    }

    private static function parse_progressive_slides_post($raw) {
        if (is_array($raw)) {
            return $raw;
        }
        if (!is_string($raw) || $raw === '') {
            return [];
        }

        $raw = wp_unslash($raw);
        $decoded = json_decode($raw, true);
        if (is_array($decoded)) {
            return $decoded;
        }

        return [];
    }

    private static function validate_progressive_slides_input($slides, $gift_pool_ids, $required_steps = 1) {
        $errors = [];
        if (!is_array($slides)) {
            $slides = [];
        }

        $gift_pool_ids = array_values(array_unique(array_filter(array_map('absint', (array) $gift_pool_ids))));
        $gift_pool_lookup = array_fill_keys($gift_pool_ids, true);
        $required_steps = max(1, intval($required_steps));

        foreach ($slides as $slide_index => $slide) {
            if (!is_array($slide)) {
                $errors[] = sprintf('Slide %d må være gyldig konfigurert.', intval($slide_index) + 1);
                continue;
            }

            $raw_ids = $slide['gift_ids'] ?? ($slide['gift_products'] ?? []);
            if (!is_array($raw_ids)) {
                $raw_ids = preg_split('/[\s,]+/', sanitize_text_field((string) $raw_ids));
            }

            $valid_ids = [];
            foreach ((array) $raw_ids as $id) {
                $id = absint($id);
                if (!$id || empty($gift_pool_lookup[$id])) {
                    continue;
                }
                $valid_ids[$id] = true;
            }

            if (empty($valid_ids)) {
                $errors[] = sprintf('Slide %d må ha minst én gyldig gave fra gaveproduktene i kampanjen.', intval($slide_index) + 1);
            }
        }

        if (count($slides) < $required_steps) {
            $errors[] = sprintf('Progressiv flyt krever minst %d slides basert på valgt gaveantall.', $required_steps);
        }

        return $errors;
    }

    private static function get_gift_image_layout_presets() {
        return [
            'compact' => [
                'label' => 'Kompakt rutenett',
                'description' => 'Små gavekort med tett oppsett (anbefalt for mange produkter).',
                'min_width' => 102,
                'aspect_ratio' => '1/1',
                'max_grid_width' => 520,
                'object_fit' => 'cover',
            ],
            'balanced' => [
                'label' => 'Balansert',
                'description' => 'God lesbarhet uten at gavekortene blir for store.',
                'min_width' => 132,
                'aspect_ratio' => '1/1',
                'max_grid_width' => 680,
                'object_fit' => 'cover',
            ],
            'airy' => [
                'label' => 'Luftig kort',
                'description' => 'Mer avstand og litt større kort for enklere klikk.',
                'min_width' => 150,
                'aspect_ratio' => '1/1',
                'max_grid_width' => 760,
                'object_fit' => 'cover',
            ],
            'wide' => [
                'label' => 'Bredt kort (4:3)',
                'description' => 'Bredere bilder som viser mer av produktet.',
                'min_width' => 160,
                'aspect_ratio' => '4/3',
                'max_grid_width' => 820,
                'object_fit' => 'cover',
            ],
            'portrait' => [
                'label' => 'Portrett (3:4)',
                'description' => 'Høyere kort som passer for stående produktbilder.',
                'min_width' => 132,
                'aspect_ratio' => '3/4',
                'max_grid_width' => 680,
                'object_fit' => 'cover',
            ],
            'gallery' => [
                'label' => 'Galleri (3:2)',
                'description' => 'Mellomting mellom bredt og kvadratisk, egnet for livsstilsbilder.',
                'min_width' => 176,
                'aspect_ratio' => '3/2',
                'max_grid_width' => 900,
                'object_fit' => 'cover',
            ],
            'spotlight' => [
                'label' => 'Spotlight (2:3)',
                'description' => 'Litt større stående kort med tydelig fokus på ett produkt.',
                'min_width' => 170,
                'aspect_ratio' => '2/3',
                'max_grid_width' => 760,
                'object_fit' => 'cover',
            ],
            'list' => [
                'label' => 'Listevisning (16:9)',
                'description' => 'Store kort i færre kolonner med god tittelplass.',
                'min_width' => 230,
                'aspect_ratio' => '16/9',
                'max_grid_width' => 980,
                'object_fit' => 'cover',
            ],
            'cinematic' => [
                'label' => 'Kinovisning (21:9)',
                'description' => 'Ekstra brede kort som gir rolig og premium uttrykk.',
                'min_width' => 260,
                'aspect_ratio' => '21/9',
                'max_grid_width' => 1100,
                'object_fit' => 'cover',
            ],
            'full-image' => [
                'label' => 'Fullt bilde',
                'description' => 'Vis hele bildet uten beskjæring.',
                'min_width' => 150,
                'aspect_ratio' => '1/1',
                'max_grid_width' => 760,
                'object_fit' => 'contain',
            ],
            'full-image-wide' => [
                'label' => 'Fullt bilde bred (4:3)',
                'description' => 'Vis hele bildet i brede kort uten å kutte motivet.',
                'min_width' => 180,
                'aspect_ratio' => '4/3',
                'max_grid_width' => 900,
                'object_fit' => 'contain',
            ],
        ];
    }

    private static function sanitize_gift_image_layout($layout) {
        $layout = sanitize_key($layout);
        $presets = self::get_gift_image_layout_presets();
        if ($layout === 'custom' || isset($presets[$layout])) {
            return $layout;
        }
        return 'compact';
    }

    private static function sanitize_gift_image_shape($shape) {
        $shape = sanitize_key($shape);
        return in_array($shape, ['square', 'round'], true) ? $shape : 'square';
    }

    private static function sanitize_gift_image_object_fit($fit) {
        $fit = sanitize_key($fit);
        return in_array($fit, ['cover', 'contain'], true) ? $fit : 'cover';
    }

    private static function sanitize_gift_image_aspect_ratio($ratio) {
        $ratio = trim((string) $ratio);
        if (!preg_match('/^([0-9]+(?:\.[0-9]+)?)\s*\/\s*([0-9]+(?:\.[0-9]+)?)$/', $ratio, $matches)) {
            return '1/1';
        }

        $width = floatval($matches[1]);
        $height = floatval($matches[2]);
        if ($width <= 0 || $height <= 0) {
            return '1/1';
        }

        return $matches[1] . '/' . $matches[2];
    }

    private static function get_gift_card_layout($campaign) {
        $layout = self::sanitize_gift_image_layout($campaign['gift_image_layout'] ?? 'compact');
        if ($layout === 'custom') {
            return [
                'layout' => 'custom',
                'min_width' => max(80, min(260, intval($campaign['gift_image_custom_min_width'] ?? 120))),
                'aspect_ratio' => self::sanitize_gift_image_aspect_ratio($campaign['gift_image_custom_aspect_ratio'] ?? '1/1'),
                'max_grid_width' => max(320, min(1200, intval($campaign['gift_image_custom_max_grid_width'] ?? 560))),
                'object_fit' => self::sanitize_gift_image_object_fit($campaign['gift_image_custom_object_fit'] ?? 'cover'),
                'shape' => self::sanitize_gift_image_shape($campaign['gift_image_shape'] ?? 'square'),
            ];
        }

        $presets = self::get_gift_image_layout_presets();
        $preset = $presets[$layout] ?? $presets['compact'];

        return [
            'layout' => $layout,
            'min_width' => intval($preset['min_width']),
            'aspect_ratio' => self::sanitize_gift_image_aspect_ratio($preset['aspect_ratio']),
            'max_grid_width' => intval($preset['max_grid_width']),
            'object_fit' => in_array($preset['object_fit'], ['cover', 'contain'], true) ? $preset['object_fit'] : 'cover',
            'shape' => self::sanitize_gift_image_shape($campaign['gift_image_shape'] ?? 'square'),
        ];
    }

    public static function enqueue_admin_assets($hook) {
        if ($hook !== 'woocommerce_page_ggw-free-gifts') {
            return;
        }

        if (function_exists('wp_enqueue_media')) {
            wp_enqueue_media();
        }

        wp_enqueue_script('selectWoo');
        wp_enqueue_style('select2');
        wp_enqueue_script('wc-enhanced-select');

        $admin_css = <<<'GGWCSS'
.ggw-multiselect{min-width:420px;max-width:100%;}
.ggw-gift-config-shell{max-width:980px;display:grid;gap:12px;}
.ggw-gift-config-toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;}
.ggw-gift-config-toolbar label{display:grid;gap:4px;min-width:220px;}
.ggw-gift-config-toolbar select,.ggw-gift-config-toolbar input{max-width:100%;}
.ggw-gift-config-hint{margin:0;color:#4b5563;font-size:12px;line-height:1.45;}
.ggw-gift-layout-chip-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:10px;}
.ggw-gift-layout-chip{border:1px solid #d1d5db;border-radius:12px;background:#fff;padding:10px;text-align:left;cursor:pointer;display:grid;gap:8px;transition:border-color .15s ease,box-shadow .15s ease,transform .15s ease;}
.ggw-gift-layout-chip:hover{border-color:#93c5fd;transform:translateY(-1px);}
.ggw-gift-layout-chip:focus-visible{outline:2px solid #2563eb;outline-offset:1px;}
.ggw-gift-layout-chip.is-active{border-color:#2563eb;box-shadow:0 0 0 1px #2563eb inset;background:#eff6ff;}
.ggw-gift-layout-chip-head{display:flex;align-items:center;justify-content:space-between;gap:8px;}
.ggw-gift-layout-chip-badge{display:inline-flex;align-items:center;font-size:11px;line-height:1;padding:4px 7px;border-radius:999px;background:#e5e7eb;color:#111827;}
.ggw-gift-layout-chip.is-active .ggw-gift-layout-chip-badge{background:#dbeafe;color:#1d4ed8;}
.ggw-gift-layout-chip-note{font-size:12px;line-height:1.4;color:#4b5563;}
.ggw-gift-appearance-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;max-width:980px;}
.ggw-gift-custom-wrap{border:1px solid #d1d5db;border-radius:12px;padding:12px;background:#f9fafb;}
.ggw-gift-custom-wrap legend{font-weight:600;padding:0 6px;}
.ggw-gift-preview{border:1px solid #d1d5db;border-radius:12px;padding:12px;background:#fff;max-width:980px;}
.ggw-gift-preview-header{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
.ggw-gift-preview-meta{font-size:12px;color:#1f2937;background:#f3f4f6;border-radius:999px;padding:4px 8px;}
.ggw-gift-preview-grid{display:grid;gap:10px}
.ggw-gift-preview-card{border:1px solid #d1d5db;border-radius:10px;padding:8px;background:#fff}
.ggw-gift-preview-media{width:100%;aspect-ratio:1/1;border-radius:8px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center}
.ggw-gift-preview-media img{width:100%;height:100%;object-fit:cover;display:block}
.ggw-gift-preview-title{margin-top:6px;font-size:12px;line-height:1.35;color:#111827;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:32px}
.ggw-gift-preview-help{font-size:12px;color:#4b5563;margin-top:8px}
.ggw-gift-preset-preview-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;max-width:980px}
.ggw-gift-preset-preview{border:1px solid #d1d5db;border-radius:10px;padding:10px;background:#fff;cursor:pointer;transition:border-color .15s ease,box-shadow .15s ease,transform .15s ease}
.ggw-gift-preset-preview:hover{border-color:#93c5fd;transform:translateY(-1px)}
.ggw-gift-preset-preview:focus-visible{outline:2px solid #2563eb;outline-offset:1px}
.ggw-gift-preset-preview.is-active{border-color:#2563eb;box-shadow:0 0 0 1px #2563eb inset;background:#eff6ff}
.ggw-gift-preset-preview-head{display:flex;justify-content:space-between;align-items:center;gap:8px;font-size:12px;margin-bottom:8px;color:#111827}
.ggw-gift-preset-preview-note{color:#4b5563;font-size:11px;line-height:1.4}
.ggw-progressive-wrap{margin-top:8px;max-width:1100px}
.ggw-progressive-table{width:100%;border-collapse:collapse}
.ggw-progressive-table th,.ggw-progressive-table td{padding:8px;border-bottom:1px solid #e5e7eb;vertical-align:top}
.ggw-progressive-actions{display:flex;gap:6px;flex-wrap:wrap}
.ggw-progressive-add{margin-top:8px}
.ggw-progressive-empty{padding:10px;border:1px dashed #d1d5db;border-radius:8px;background:#f9fafb;color:#4b5563}
.ggw-progressive-choice-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
.ggw-progressive-choice{display:flex;align-items:flex-start;gap:8px;border:1px solid #d1d5db;border-radius:8px;padding:7px 9px;background:#fff}
.ggw-progressive-choice input{margin-top:2px}
.ggw-progressive-choice span{font-size:12px;line-height:1.35}
@media (max-width:782px){
  .ggw-progressive-table thead{display:none}
  .ggw-progressive-table tr{display:block;border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-bottom:8px}
  .ggw-progressive-table td{display:block;border:0;padding:4px 0}
}
GGWCSS;
        wp_add_inline_style('woocommerce_admin_styles', $admin_css);

        $admin_js = <<<'GGWJS'
(function(){
    var init=function(){
        var panel=document.querySelector('[data-ggw-gift-config]');
        var presets={};
        var layoutField=null;
        var shapeField=null;
        var minField=null;
        var ratioField=null;
        var maxField=null;
        var fitField=null;
        var customWrap=null;
        var livePreview=null;
        var previewMeta=null;
        var customToggleHint=null;

        if(panel){
            layoutField=panel.querySelector('[name="gift_image_layout"]');
            shapeField=panel.querySelector('[name="gift_image_shape"]');
            minField=panel.querySelector('[name="gift_image_custom_min_width"]');
            ratioField=panel.querySelector('[name="gift_image_custom_aspect_ratio"]');
            maxField=panel.querySelector('[name="gift_image_custom_max_grid_width"]');
            fitField=panel.querySelector('[name="gift_image_custom_object_fit"]');
            customWrap=panel.querySelector('[data-ggw-custom-controls]');
            livePreview=panel.querySelector('[data-ggw-live-preview-grid]');
            previewMeta=panel.querySelector('[data-ggw-preview-meta]');
            customToggleHint=panel.querySelector('[data-ggw-custom-toggle-hint]');

            panel.querySelectorAll('option[data-ggw-preset]').forEach(function(opt){
                presets[opt.value]={
                    min:parseInt(opt.getAttribute('data-min-width')||'120',10),
                    ratio:opt.getAttribute('data-aspect-ratio')||'1/1',
                    max:parseInt(opt.getAttribute('data-max-grid-width')||'560',10),
                    fit:opt.getAttribute('data-object-fit')||'cover',
                    label:opt.textContent||opt.value
                };
            });
        }

        var clamp=function(v,min,max){
            v=parseInt(v||0,10);
            if(isNaN(v)){v=min;}
            return Math.max(min,Math.min(max,v));
        };

        var parseRatio=function(v){
            var m=String(v||'').trim().match(/^([0-9]+(?:\.[0-9]+)?)\s*\/\s*([0-9]+(?:\.[0-9]+)?)/);
            if(!m){return '1 / 1';}
            var w=parseFloat(m[1]);
            var h=parseFloat(m[2]);
            if(!w||!h){return '1 / 1';}
            return w+' / '+h;
        };

        var applyLayout=function(grid,preset,shape){
            if(!grid||!preset){return;}
            grid.style.gridTemplateColumns='repeat(auto-fit,minmax('+preset.min+'px,1fr))';
            grid.style.maxWidth=preset.max+'px';
            grid.querySelectorAll('[data-ggw-preview-media]').forEach(function(el){
                el.style.aspectRatio=parseRatio(preset.ratio);
                el.style.borderRadius=shape==='round'?'999px':'8px';
            });
            grid.querySelectorAll('[data-ggw-preview-image]').forEach(function(el){
                el.style.objectFit=preset.fit;
            });
        };

        var renderPresetGallery=function(shape){
            var list=panel.querySelector('[data-ggw-preset-preview-list]');
            if(!list){return;}
            var active=layoutField?layoutField.value:'compact';
            list.querySelectorAll('[data-ggw-preset-preview]').forEach(function(item){
                var key=item.getAttribute('data-layout');
                var isActive=key===active;
                item.classList.toggle('is-active',isActive);
                item.setAttribute('aria-pressed',isActive?'true':'false');
                var grid=item.querySelector('[data-ggw-preview-grid]');
                applyLayout(grid,presets[key]||presets.compact,shape);
            });
        };

        var renderPresetChips=function(){
            var active=layoutField?layoutField.value:'compact';
            panel.querySelectorAll('[data-ggw-layout-chip]').forEach(function(chip){
                var key=chip.getAttribute('data-layout')||'';
                var isActive=key===active;
                chip.classList.toggle('is-active',isActive);
                chip.setAttribute('aria-pressed',isActive?'true':'false');
            });
        };

        var updatePreviewMeta=function(layout,preset,isCustom){
            if(!previewMeta||!preset){return;}
            var label=isCustom?'Tilpasset':((presets[layout]&&presets[layout].label)||layout);
            previewMeta.textContent='Aktivt oppsett: '+label+' · '+preset.ratio+' · min '+preset.min+'px · max '+preset.max+'px';
        };

        var update=function(){
            var layout=layoutField?layoutField.value:'compact';
            var shape=shapeField?shapeField.value:'square';
            var isCustom=layout==='custom';
            if(customWrap){customWrap.style.display=isCustom?'grid':'none';}

            var chosen=isCustom ? {
                min:clamp(minField&&minField.value,80,260),
                ratio:(ratioField&&ratioField.value)||'1/1',
                max:clamp(maxField&&maxField.value,320,1200),
                fit:(fitField&&fitField.value)||'cover'
            } : (presets[layout]||presets.compact||{min:120,ratio:'1/1',max:560,fit:'cover'});

            applyLayout(livePreview,chosen,shape);
            renderPresetGallery(shape);
            renderPresetChips();
            updatePreviewMeta(layout,chosen,isCustom);
            if(customToggleHint){customToggleHint.style.display=isCustom?'none':'inline';}
        };

        var setLayoutValue=function(key){
            if(!layoutField||!key){return;}
            layoutField.value=key;
            layoutField.dispatchEvent(new Event('change',{bubbles:true}));
            update();
        };

        if(panel){
            panel.querySelectorAll('[data-ggw-layout-chip]').forEach(function(chip){
                chip.addEventListener('click',function(){
                    setLayoutValue(chip.getAttribute('data-layout'));
                });
            });
        }

        if(panel){
            panel.querySelectorAll('[data-ggw-preset-preview]').forEach(function(card){
                card.addEventListener('click',function(){
                    setLayoutValue(card.getAttribute('data-layout'));
                });
                card.addEventListener('keydown',function(e){
                    if(e.key==='Enter' || e.key===' '){
                        e.preventDefault();
                        setLayoutValue(card.getAttribute('data-layout'));
                    }
                });
            });
        }

        [layoutField,shapeField,minField,ratioField,maxField,fitField].forEach(function(el){
            if(!el){return;}
            el.addEventListener('input',update);
            el.addEventListener('change',update);
        });

        if(panel){
            update();
        }

        var modeField=document.querySelector('[name="gift_chooser_mode"]');
        var progressiveWrap=document.querySelector('[data-ggw-progressive-wrap]');
        var progressiveBody=document.querySelector('[data-ggw-progressive-slides]');
        var progressiveTemplate=document.querySelector('[data-ggw-progressive-template]');
        var addSlideBtn=document.querySelector('[data-ggw-progressive-add]');
        var form=modeField?modeField.closest('form'):null;

        var getGiftPool=function(){
            var out=[];
            var seen={};
            var giftField=document.querySelector('[name="gift_products_csv[]"]')||document.querySelector('[name="gift_products_csv"]');
            if(!giftField){return out;}

            if(window.jQuery){
                var jq=window.jQuery(giftField);
                if(jq && typeof jq.selectWoo==='function'){
                    var selectedData=jq.selectWoo('data')||[];
                    selectedData.forEach(function(item){
                        var id=parseInt(item&&item.id||'0',10);
                        if(!id||seen[id]){return;}
                        seen[id]=true;
                        out.push({id:String(id),label:String(item.text||('Produkt #'+id)).trim()});
                    });
                }
            }

            Array.prototype.slice.call(giftField.selectedOptions||giftField.options||[]).forEach(function(opt){
                if(!opt.selected && giftField.selectedOptions){return;}
                var id=parseInt(opt.value||'0',10);
                if(!id||seen[id]){return;}
                seen[id]=true;
                out.push({id:String(id),label:(opt.textContent||('Produkt #'+id)).trim()});
            });
            return out;
        };

        var renumber=function(){
            if(!progressiveBody){return;}
            progressiveBody.querySelectorAll('[data-ggw-slide-row]').forEach(function(row,index){
                row.setAttribute('data-index',String(index));
                var label=row.querySelector('[data-ggw-slide-label]');
                if(label){label.textContent='Slide '+(index+1);}
                row.querySelectorAll('[data-ggw-field="gift_ids"]').forEach(function(input){
                    input.name='progressive_slides['+index+'][gift_ids][]';
                });
            });
        };

        var syncSlideChoices=function(){
            if(!progressiveBody){return;}
            var pool=getGiftPool();
            progressiveBody.querySelectorAll('[data-ggw-slide-choices]').forEach(function(container){
                var selectedMap={};
                container.querySelectorAll('[data-ggw-field="gift_ids"]:checked').forEach(function(input){
                    selectedMap[input.value]=true;
                });
                container.innerHTML='';
                if(!pool.length){
                    container.innerHTML='<p class="ggw-progressive-empty">Velg gaveprodukter over for å tilordne hva kunden kan se i hver slide.</p>';
                    return;
                }
                var frag=document.createDocumentFragment();
                pool.forEach(function(item){
                    var parentRow=container.closest('[data-ggw-slide-row]');
                    var rowIndex=parentRow?parentRow.getAttribute('data-index'):'0';
                    var id='ggw-slide-'+rowIndex+'-gift-'+item.id;
                    var choice=document.createElement('label');
                    choice.className='ggw-progressive-choice';

                    var input=document.createElement('input');
                    input.type='checkbox';
                    input.setAttribute('data-ggw-field','gift_ids');
                    input.value=item.id;
                    input.name='';
                    input.checked=!!selectedMap[item.id];
                    input.id=id;

                    var text=document.createElement('span');
                    text.textContent=item.label;

                    choice.appendChild(input);
                    choice.appendChild(text);
                    frag.appendChild(choice);
                });
                container.appendChild(frag);
            });
            renumber();
        };

        var updateModeVisibility=function(){
            if(!modeField||!progressiveWrap){return;}
            progressiveWrap.style.display=modeField.value==='progressive'?'block':'none';
        };

        var addRow=function(selectedIds){
            if(!progressiveBody||!progressiveTemplate){return;}
            var idx=progressiveBody.querySelectorAll('[data-ggw-slide-row]').length;
            var html=progressiveTemplate.innerHTML.replace(/__index__/g,String(idx));
            var temp=document.createElement('tbody');
            temp.innerHTML=html.trim();
            var row=temp.querySelector('[data-ggw-slide-row]');
            if(!row){return;}
            progressiveBody.appendChild(row);
            syncSlideChoices();
            if(Array.isArray(selectedIds)&&selectedIds.length){
                row.querySelectorAll('[data-ggw-field="gift_ids"]').forEach(function(input){
                    input.checked=selectedIds.indexOf(input.value)!==-1;
                });
            }
            renumber();
        };

        if(addSlideBtn){
            addSlideBtn.addEventListener('click',function(e){
                e.preventDefault();
                addRow([]);
            });
        }

        if(progressiveBody){
            progressiveBody.addEventListener('click',function(e){
                var btn=e.target.closest('button');
                if(!btn){return;}
                var row=btn.closest('[data-ggw-slide-row]');
                if(!row){return;}
                if(btn.matches('[data-ggw-remove-slide]')){
                    e.preventDefault();
                    row.remove();
                    renumber();
                    return;
                }
                if(btn.matches('[data-ggw-move-up]')){
                    e.preventDefault();
                    var prev=row.previousElementSibling;
                    if(prev){progressiveBody.insertBefore(row,prev);renumber();}
                    return;
                }
                if(btn.matches('[data-ggw-move-down]')){
                    e.preventDefault();
                    var next=row.nextElementSibling;
                    if(next){progressiveBody.insertBefore(next,row);renumber();}
                }
            });
        }

        var giftField=document.querySelector('[name="gift_products_csv[]"]')||document.querySelector('[name="gift_products_csv"]');
        if(giftField){
            giftField.addEventListener('change',syncSlideChoices);
            giftField.addEventListener('input',syncSlideChoices);
            if(window.jQuery){
                window.jQuery(giftField).on('select2:select select2:unselect',syncSlideChoices);
            }
        }
        if(modeField){
            modeField.addEventListener('change',updateModeVisibility);
            modeField.addEventListener('input',updateModeVisibility);
        }
        if(form){
            form.addEventListener('submit',renumber);
        }

        updateModeVisibility();
        renumber();
        syncSlideChoices();
    };

    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded',init);
    }else{
        init();
    }
})();
GGWJS;

        wp_add_inline_script('wc-enhanced-select', $admin_js);
    }

    public static function render_admin_page() {
        if (!current_user_can('manage_woocommerce')) return;
        $campaigns = self::get_campaigns();
        $edit_id = sanitize_text_field(wp_unslash($_GET['edit_campaign'] ?? ''));
        $editing = self::normalize_campaign([]);

        if ($edit_id) {
            foreach ($campaigns as $campaign) {
                if ($campaign['id'] === $edit_id) {
                    $editing = $campaign;
                    break;
                }
            }
        }

        ?>
        <div class="wrap">
            <h1>Gratis gave-kampanjer</h1>
            <p>Opprett eller rediger kampanjer. Høyere prioritet vinner ved overlapp.</p>

            <?php if (!self::checkout_fallback_is_supported()): ?>
                <div class="notice notice-warning inline">
                    <p>
                        <strong>Kasse-fallback for gavevalg er deaktivert:</strong>
                        Aktiv checkout-modus er <em><?php echo esc_html(self::get_checkout_mode_label()); ?></em>,
                        og fallback-funksjonen i denne versjonen støtter kun klassisk kasse
                        (<code>woocommerce_review_order_before_payment</code> + <code>woocommerce_checkout_process</code>).
                    </p>
                </div>
            <?php endif; ?>

            <form method="post">
                <?php wp_nonce_field(self::NONCE_ACTION, 'ggw_nonce'); ?>
                <input type="hidden" name="ggw_action" value="save_campaign">
                <input type="hidden" name="campaign_id" value="<?php echo esc_attr($editing['id']); ?>">

                <table class="form-table">
                    <tr><th colspan="2"><h2 style="margin:0;">Grunninnstillinger</h2><p class="description" style="margin:6px 0 0;">Fyll inn disse først. Dette er nok for å få en enkel kampanje i gang.</p></th></tr>

                    <tr><th>Kampanjenavn</th><td><input type="text" name="title" class="regular-text" value="<?php echo esc_attr($editing['title']); ?>" required><p class="description">Navnet brukes kun internt i admin, så velg et navn du lett kjenner igjen.</p></td></tr>
                    <tr><th>Aktiver kampanjen</th><td><label><input type="checkbox" name="active" value="1" <?php checked(!empty($editing['active'])); ?>> Kampanjen er aktiv nå</label><p class="description">Skru av hvis du vil lagre uten at kunder ser den enda.</p></td></tr>
                    <tr><th>Startdato (valgfri)</th><td><input type="datetime-local" name="start" value="<?php echo esc_attr($editing['start']); ?>"><p class="description">La feltet stå tomt for å starte med en gang.</p></td></tr>
                    <tr><th>Sluttdato (valgfri)</th><td><input type="datetime-local" name="end" value="<?php echo esc_attr($editing['end']); ?>"><p class="description">La feltet stå tomt hvis kampanjen skal løpe til du stopper den manuelt.</p></td></tr>

                    <tr><th>Produkter som utløser gave</th><td><?php self::render_product_multiselect('trigger_products_csv', $editing['trigger_products']); ?><p class="description">Velg produkter som skal gi rett på gave.</p></td></tr>
                    <tr><th>Kategorier som utløser gave</th><td><?php self::render_term_multiselect('trigger_categories_csv', 'product_cat', $editing['trigger_categories']); ?><p class="description">Valgfritt: alle produkter i disse kategoriene teller som utløserprodukter.</p></td></tr>
                    <tr><th>Tagger som utløser gave</th><td><?php self::render_term_multiselect('trigger_tags_csv', 'product_tag', $editing['trigger_tags']); ?><p class="description">Valgfritt: produkter med disse taggene teller også.</p></td></tr>

                    <tr><th>Minste antall utløserprodukter</th><td><input type="number" name="min_qty" value="<?php echo esc_attr($editing['min_qty']); ?>" min="1"><p class="description">Eksempel: 2 betyr at kunden må ha minst 2 kvalifiserende produkter i kurven.</p></td></tr>
                    <tr><th>Minimum ordrebeløp</th><td><input type="number" name="min_subtotal" value="<?php echo esc_attr($editing['min_subtotal']); ?>" min="0" step="0.01"><p class="description">0 betyr ingen beløpsgrense.</p></td></tr>
                    <tr><th>Gaveprodukter kunden kan få</th><td><?php self::render_product_multiselect('gift_products_csv', $editing['gift_products'], true); ?><p class="description">Disse produktene blir tilgjengelige som gratis gavevalg.</p></td></tr>
                    <tr><th>Maks per spesifikk gave</th><td><?php self::render_gift_limits_fields($editing); ?><p class="description">Sett valgfri maksgrense per gaveprodukt i samme kampanje.</p></td></tr>
                    <tr><th>Hvor mange gaver kunden kan velge</th><td><input type="number" name="gifts_to_choose" value="<?php echo esc_attr($editing['gifts_to_choose']); ?>" min="1"> gave(r)<p class="description">Antall gavevalg per oppnådd "gave-runde".</p></td></tr>
                    <tr>
                        <th>Gift chooser experience</th>
                        <td>
                            <select name="gift_chooser_mode">
                                <option value="classic" <?php selected($editing['gift_chooser_mode'] ?? 'classic', 'classic'); ?>>Current chooser view</option>
                                <option value="progressive" <?php selected($editing['gift_chooser_mode'] ?? 'classic', 'progressive'); ?>>Progressive flow view</option>
                            </select>
                            <p class="description">Velg hvordan gavevelgeren presenteres for kunden.</p>
                        </td>
                    </tr>
                    <tr data-ggw-progressive-wrap>
                        <th>Progressive slides</th>
                        <td>
                            <div class="ggw-progressive-wrap">
                                <table class="ggw-progressive-table widefat striped">
                                    <thead>
                                        <tr>
                                            <th style="width:120px">Slide</th>
                                            <th>Produkter i slide</th>
                                            <th style="width:240px">Handlinger</th>
                                        </tr>
                                    </thead>
                                    <tbody data-ggw-progressive-slides>
                                        <?php if (!empty($editing['progressive_slides'])): ?>
                                            <?php foreach ($editing['progressive_slides'] as $slide_index => $slide): ?>
                                                <tr data-ggw-slide-row data-index="<?php echo esc_attr(intval($slide_index)); ?>">
                                                    <td><strong data-ggw-slide-label><?php echo esc_html('Slide ' . (intval($slide_index) + 1)); ?></strong></td>
                                                    <td>
                                                        <div class="ggw-progressive-choice-grid" data-ggw-slide-choices>
                                                            <?php foreach ((array) ($editing['gift_products'] ?? []) as $gift_id): ?>
                                                                <?php $gift_product = wc_get_product($gift_id); if (!$gift_product) { continue; } ?>
                                                                <label class="ggw-progressive-choice">
                                                                    <input type="checkbox" data-ggw-field="gift_ids" name="progressive_slides[<?php echo esc_attr(intval($slide_index)); ?>][gift_ids][]" value="<?php echo esc_attr($gift_id); ?>" <?php checked(in_array($gift_id, (array) ($slide['gift_ids'] ?? []), true)); ?>>
                                                                    <span><?php echo wp_kses_post($gift_product->get_formatted_name()); ?></span>
                                                                </label>
                                                            <?php endforeach; ?>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="ggw-progressive-actions">
                                                            <button type="button" class="button" data-ggw-move-up>Opp</button>
                                                            <button type="button" class="button" data-ggw-move-down>Ned</button>
                                                            <button type="button" class="button button-link-delete" data-ggw-remove-slide>Fjern</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            <?php endforeach; ?>
                                        <?php else: ?>
                                            <tr data-ggw-slide-row data-index="0">
                                                <td><strong data-ggw-slide-label>Slide 1</strong></td>
                                                <td>
                                                    <div class="ggw-progressive-choice-grid" data-ggw-slide-choices>
                                                        <p class="ggw-progressive-empty">Velg gaveprodukter over for å tilordne hva kunden kan se i hver slide.</p>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="ggw-progressive-actions">
                                                        <button type="button" class="button" data-ggw-move-up>Opp</button>
                                                        <button type="button" class="button" data-ggw-move-down>Ned</button>
                                                        <button type="button" class="button button-link-delete" data-ggw-remove-slide>Fjern</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <?php endif; ?>
                                    </tbody>
                                </table>
                                <button type="button" class="button ggw-progressive-add" data-ggw-progressive-add>+ Legg til slide</button>
                                <p class="description">Marker gavene som skal vises i hver slide. Bare produkter valgt i «Gaveprodukter kunden kan få» kan brukes her, og hver slide må ha minst ett valg.</p>
                                <script type="text/template" data-ggw-progressive-template>
                                    <tr data-ggw-slide-row data-index="__index__">
                                        <td><strong data-ggw-slide-label>Slide __index__</strong></td>
                                        <td>
                                            <div class="ggw-progressive-choice-grid" data-ggw-slide-choices>
                                                <p class="ggw-progressive-empty">Velg gaveprodukter over for å tilordne hva kunden kan se i hver slide.</p>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="ggw-progressive-actions">
                                                <button type="button" class="button" data-ggw-move-up>Opp</button>
                                                <button type="button" class="button" data-ggw-move-down>Ned</button>
                                                <button type="button" class="button button-link-delete" data-ggw-remove-slide>Fjern</button>
                                            </div>
                                        </td>
                                    </tr>
                                </script>
                            </div>
                        </td>
                    </tr>
                    <tr><th>Maks gaver per ordre</th><td><input type="number" name="max_gifts_per_order" value="<?php echo esc_attr($editing['max_gifts_per_order']); ?>" min="1"><p class="description" style="margin-top:6px;">Sikkerhetsgrense for antall gaver i én bestilling. Regel: treff = gulv(trigger-antall / minimum antall trigger). Gaverett = min(maks gaver per ordre, treff × kunden kan velge).</p></td></tr>
                    <tr><th>Bildevisning for gavevalg</th><td data-ggw-gift-config>
                        <?php $gift_layout_presets = self::get_gift_image_layout_presets(); ?>
                        <div class="ggw-gift-config-shell">
                            <div class="ggw-gift-config-toolbar">
                                <label for="ggw_gift_image_layout">Preset
                                    <select id="ggw_gift_image_layout" name="gift_image_layout" aria-describedby="ggw-layout-help">
                                        <?php foreach ($gift_layout_presets as $layout_key => $layout_preset): ?>
                                            <option value="<?php echo esc_attr($layout_key); ?>" data-ggw-preset="1" data-min-width="<?php echo esc_attr(intval($layout_preset['min_width'])); ?>" data-aspect-ratio="<?php echo esc_attr($layout_preset['aspect_ratio']); ?>" data-max-grid-width="<?php echo esc_attr(intval($layout_preset['max_grid_width'])); ?>" data-object-fit="<?php echo esc_attr($layout_preset['object_fit']); ?>" <?php selected($editing['gift_image_layout'] ?? 'compact', $layout_key); ?>><?php echo esc_html($layout_preset['label']); ?></option>
                                        <?php endforeach; ?>
                                        <option value="custom" <?php selected($editing['gift_image_layout'] ?? 'compact', 'custom'); ?>>Tilpasset</option>
                                    </select>
                                </label>
                                <label for="ggw_gift_image_shape">Form på bilde
                                    <select id="ggw_gift_image_shape" name="gift_image_shape">
                                        <option value="square" <?php selected($editing['gift_image_shape'] ?? 'square', 'square'); ?>>Kvadratisk kort</option>
                                        <option value="round" <?php selected($editing['gift_image_shape'] ?? 'square', 'round'); ?>>Rundt kort</option>
                                    </select>
                                </label>
                            </div>
                            <p class="ggw-gift-config-hint" id="ggw-layout-help">Velg et preset i listen eller klikk på preset-kortene under for rask sammenligning. <span data-ggw-custom-toggle-hint>Velg «Tilpasset» for egne verdier.</span></p>
                            <div class="ggw-gift-layout-chip-list" role="group" aria-label="Velg layout preset">
                                <?php foreach ($gift_layout_presets as $layout_key => $layout_preset): ?>
                                    <button type="button" class="ggw-gift-layout-chip" data-ggw-layout-chip data-layout="<?php echo esc_attr($layout_key); ?>" aria-pressed="false">
                                        <span class="ggw-gift-layout-chip-head">
                                            <strong><?php echo esc_html($layout_preset['label']); ?></strong>
                                            <span class="ggw-gift-layout-chip-badge"><?php echo esc_html($layout_preset['aspect_ratio']); ?></span>
                                        </span>
                                        <span class="ggw-gift-layout-chip-note"><?php echo esc_html($layout_preset['description']); ?></span>
                                    </button>
                                <?php endforeach; ?>
                            </div>
                        </div>
                        <fieldset class="ggw-gift-appearance-controls ggw-gift-custom-wrap" data-ggw-custom-controls style="margin-top:8px;">
                            <legend>Tilpasset layout</legend>
                            <label>Tilpasset min-kortbredde (px)<br><input type="number" name="gift_image_custom_min_width" min="80" max="260" value="<?php echo esc_attr($editing['gift_image_custom_min_width']); ?>"></label>
                            <label>Tilpasset sideforhold<br><input type="text" name="gift_image_custom_aspect_ratio" value="<?php echo esc_attr($editing['gift_image_custom_aspect_ratio']); ?>" placeholder="1/1"></label>
                            <label>Tilpasset maks grid-bredde (px)<br><input type="number" name="gift_image_custom_max_grid_width" min="320" max="1200" value="<?php echo esc_attr($editing['gift_image_custom_max_grid_width']); ?>"></label>
                            <label>Tilpasset bilde-tilpasning<br>
                                <select name="gift_image_custom_object_fit">
                                    <option value="cover" <?php selected($editing['gift_image_custom_object_fit'] ?? 'cover', 'cover'); ?>>Beskjær (cover)</option>
                                    <option value="contain" <?php selected($editing['gift_image_custom_object_fit'] ?? 'cover', 'contain'); ?>>Vis hele (contain)</option>
                                </select>
                            </label>
                        </fieldset>
                        <div class="ggw-gift-preview">
                            <div class="ggw-gift-preview-header">
                                <strong>Live forhåndsvisning av valgt layout</strong>
                                <span class="ggw-gift-preview-meta" data-ggw-preview-meta></span>
                            </div>
                            <div class="ggw-gift-preview-grid" data-ggw-preview-grid data-ggw-live-preview-grid style="margin-top:8px;">
                                <div class="ggw-gift-preview-card"><span class="ggw-gift-preview-media" data-ggw-preview-media><img data-ggw-preview-image src="<?php echo esc_url(wc_placeholder_img_src('woocommerce_thumbnail')); ?>" alt="Eksempel gave"></span><span class="ggw-gift-preview-title">Kattnakken eksempelgave</span></div>
                                <div class="ggw-gift-preview-card"><span class="ggw-gift-preview-media" data-ggw-preview-media><img data-ggw-preview-image src="<?php echo esc_url(wc_placeholder_img_src('woocommerce_thumbnail')); ?>" alt="Eksempel gave"></span><span class="ggw-gift-preview-title">Ullsokk med mønster</span></div>
                                <div class="ggw-gift-preview-card"><span class="ggw-gift-preview-media" data-ggw-preview-media><img data-ggw-preview-image src="<?php echo esc_url(wc_placeholder_img_src('woocommerce_thumbnail')); ?>" alt="Eksempel gave"></span><span class="ggw-gift-preview-title">Reparasjonslapper til regntøy</span></div>
                            </div>
                            <div class="ggw-gift-preview-help">Tips: Hvis kort overlapper i frontend, velg «Kompakt rutenett» eller øk maks grid-bredde. Rund form kan gi bedre fokus når gavebildene er kvadratiske.</div>
                        </div>
                        <div class="ggw-gift-preset-preview-list" data-ggw-preset-preview-list>
                            <?php foreach ($gift_layout_presets as $layout_key => $layout_preset): ?>
                                <div class="ggw-gift-preset-preview" data-ggw-preset-preview data-layout="<?php echo esc_attr($layout_key); ?>" role="button" tabindex="0" aria-pressed="false">
                                    <div class="ggw-gift-preset-preview-head">
                                        <strong><?php echo esc_html($layout_preset['label']); ?></strong>
                                        <span><?php echo esc_html($layout_preset['aspect_ratio']); ?></span>
                                    </div>
                                    <div class="ggw-gift-preview-grid" data-ggw-preview-grid>
                                        <div class="ggw-gift-preview-card"><span class="ggw-gift-preview-media" data-ggw-preview-media><img data-ggw-preview-image src="<?php echo esc_url(wc_placeholder_img_src('woocommerce_thumbnail')); ?>" alt="Eksempel gave"></span><span class="ggw-gift-preview-title">Kattnakken eksempelgave</span></div>
                                        <div class="ggw-gift-preview-card"><span class="ggw-gift-preview-media" data-ggw-preview-media><img data-ggw-preview-image src="<?php echo esc_url(wc_placeholder_img_src('woocommerce_thumbnail')); ?>" alt="Eksempel gave"></span><span class="ggw-gift-preview-title">Ullsokk med mønster</span></div>
                                    </div>
                                    <div class="ggw-gift-preset-preview-note"><?php echo esc_html($layout_preset['description']); ?></div>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    </td></tr>

                    <tr><th colspan="2"><h2 style="margin:12px 0 0;">Tekster kunden ser</h2><p class="description" style="margin:6px 0 0;">Disse feltene styrer teksten i gaveboksen på produktsiden.</p></th></tr>
                    <tr><th>Kort overskrift</th><td><input type="text" name="headline" class="regular-text" value="<?php echo esc_attr($editing['headline']); ?>"></td></tr>
                    <tr><th>Beskrivelse / hjelpetekst</th><td><textarea name="description" rows="3" class="large-text"><?php echo esc_textarea($editing['description']); ?></textarea></td></tr>
                    <tr><th>Badge-tekst</th><td><input type="text" name="badge" class="regular-text" value="<?php echo esc_attr($editing['badge']); ?>"></td></tr>
                    <tr><th>Knappetekst (CTA)</th><td><input type="text" name="cta" class="regular-text" value="<?php echo esc_attr($editing['cta']); ?>"></td></tr>

                    <tr><th colspan="2"><h2 style="margin:12px 0 0;">Avanserte innstillinger</h2><p class="description" style="margin:6px 0 0;">For deg som vil finstyre oppførselen. Du kan la disse stå på standard hvis du er usikker.</p></th></tr>
                    <tr><th>Prioritet ved overlapp</th><td><input type="number" name="priority" value="<?php echo esc_attr($editing['priority']); ?>"><p class="description">Hvis flere kampanjer matcher samtidig, vinner høyest tall.</p></td></tr>
                    <tr><th>Ekskluder salgsvarer</th><td><label><input type="checkbox" name="exclude_sale" value="1" <?php checked(!empty($editing['exclude_sale'])); ?>> Salgsvarer teller ikke for å utløse kampanjen</label></td></tr>
                    <tr><th>Maks antall ganger per kunde</th><td><input type="number" name="max_per_customer" value="<?php echo esc_attr($editing['max_per_customer']); ?>" min="0"><p class="description">0 = ingen begrensning. 1 = kunden kan bruke kampanjen én gang totalt.</p></td></tr>
                    <tr><th>Krever aktivt gavevalg</th><td><label><input type="checkbox" name="require_choice" value="1" <?php checked(!empty($editing['require_choice'])); ?>> Kunden må velge gave før checkout</label><p class="description">Skru av hvis du vil la kunden gå videre uten å velge gave.</p></td></tr>
                    <tr><th>Auto-legg til gave</th><td><label><input type="checkbox" name="auto_gift" value="1" <?php checked(!empty($editing['auto_gift'])); ?>> Legg til første tilgjengelige gave automatisk</label><p class="description">Nyttig hvis du vil gjøre flyten så enkel som mulig.</p></td></tr>
                </table>

                <?php submit_button($edit_id ? 'Oppdater kampanje' : 'Lagre kampanje'); ?>
                <?php if ($edit_id): ?>
                    <a href="<?php echo esc_url(admin_url('admin.php?page=ggw-free-gifts')); ?>" class="button" style="margin-left:8px">Avbryt redigering</a>
                <?php endif; ?>
            </form>

            <hr>
            <h2>Eksisterende kampanjer</h2>
            <?php if (empty($campaigns)): ?>
                <p>Ingen kampanjer ennå.</p>
            <?php else: ?>
                <table class="widefat striped">
                    <thead><tr>
                        <th>Tittel</th><th>ID</th><th>Aktiv</th><th>Prioritet</th><th>Periode</th><th>Trigger produkter</th><th>Gaver</th><th>Handling</th>
                    </tr></thead>
                    <tbody>
                    <?php foreach ($campaigns as $c): ?>
                        <tr>
                            <td><?php echo esc_html($c['title']); ?></td>
                            <td><code><?php echo esc_html($c['id']); ?></code></td>
                            <td><?php echo $c['active'] ? 'Ja' : 'Nei'; ?></td>
                            <td><?php echo intval($c['priority']); ?></td>
                            <td><?php echo esc_html(($c['start'] ?: '-') . ' → ' . ($c['end'] ?: '-')); ?></td>
                            <td><?php echo esc_html(implode(',', $c['trigger_products'])); ?></td>
                            <td><?php echo esc_html(implode(',', $c['gift_products'])); ?></td>
                            <td>
                                <a class="button" href="<?php echo esc_url(admin_url('admin.php?page=ggw-free-gifts&edit_campaign=' . rawurlencode($c['id']))); ?>">Rediger</a>
                                <form method="post" style="display:inline">
                                    <?php wp_nonce_field(self::NONCE_ACTION, 'ggw_nonce'); ?>
                                    <input type="hidden" name="ggw_action" value="toggle_campaign_active">
                                    <input type="hidden" name="id" value="<?php echo esc_attr($c['id']); ?>">
                                    <button class="button" type="submit"><?php echo $c['active'] ? 'Deaktiver' : 'Aktiver'; ?></button>
                                </form>
                                <form method="post" style="display:inline">
                                    <?php wp_nonce_field(self::NONCE_ACTION, 'ggw_nonce'); ?>
                                    <input type="hidden" name="ggw_action" value="delete_campaign">
                                    <input type="hidden" name="id" value="<?php echo esc_attr($c['id']); ?>">
                                    <button class="button button-link-delete" onclick="return confirm('Slette kampanje?')">Slett</button>
                                </form>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                    </tbody>
                </table>
            <?php endif; ?>
        </div>
        <?php
    }

    private static function render_product_multiselect($field_name, $selected_ids, $required = false) {
        $selected_ids = array_values(array_unique(array_filter(array_map('absint', (array) $selected_ids))));
        ?>
        <select
            class="wc-product-search"
            multiple="multiple"
            style="width:420px;max-width:100%;"
            name="<?php echo esc_attr($field_name); ?>[]"
            data-placeholder="<?php echo esc_attr__('Søk etter produkter…', 'gratisgavewoo'); ?>"
            data-action="woocommerce_json_search_products_and_variations"
            <?php echo $required ? 'required' : ''; ?>
        >
            <?php foreach ($selected_ids as $product_id):
                $product = wc_get_product($product_id);
                if (!$product) {
                    continue;
                }
                ?>
                <option value="<?php echo esc_attr($product_id); ?>" selected="selected">
                    <?php echo wp_kses_post($product->get_formatted_name()); ?>
                </option>
            <?php endforeach; ?>
        </select>
        <?php
    }

    private static function render_term_multiselect($field_name, $taxonomy, $selected_ids) {
        $taxonomy = sanitize_key($taxonomy);
        $selected_ids = array_values(array_unique(array_filter(array_map('absint', (array) $selected_ids))));
        $terms = get_terms([
            'taxonomy' => $taxonomy,
            'hide_empty' => false,
            'orderby' => 'name',
            'order' => 'ASC',
        ]);

        if (is_wp_error($terms)) {
            $terms = [];
        }
        ?>
        <select class="wc-enhanced-select" multiple="multiple" style="width:420px;max-width:100%;" name="<?php echo esc_attr($field_name); ?>[]" data-placeholder="<?php echo esc_attr__('Velg…', 'gratisgavewoo'); ?>">
            <?php foreach ($terms as $term): ?>
                <option value="<?php echo esc_attr($term->term_id); ?>" <?php selected(in_array(intval($term->term_id), $selected_ids, true)); ?>>
                    <?php echo esc_html($term->name); ?>
                </option>
            <?php endforeach; ?>
        </select>
        <?php
    }

    private static function render_gift_limits_fields($campaign) {
        $gift_ids = array_values(array_unique(array_filter(array_map('absint', (array) ($campaign['gift_products'] ?? [])))));
        $limits = is_array($campaign['gift_product_limits'] ?? null) ? $campaign['gift_product_limits'] : [];

        if (empty($gift_ids)) {
            echo '<p class="description">Velg gaveprodukter først for å sette per-produktgrense.</p>';
            return;
        }

        echo '<div style="display:grid;gap:8px;max-width:520px;">';
        foreach ($gift_ids as $gift_id) {
            $product = wc_get_product($gift_id);
            $label = $product ? $product->get_formatted_name() : ('#' . $gift_id);
            $value = max(0, intval($limits[$gift_id] ?? 0));

            echo '<label style="display:flex;align-items:center;justify-content:space-between;gap:12px;">';
            echo '<span>' . wp_kses_post($label) . '</span>';
            echo '<input type="number" min="0" step="1" name="gift_product_limits[' . esc_attr($gift_id) . ']" value="' . esc_attr($value) . '" style="width:90px;">';
            echo '</label>';
        }
        echo '</div>';
    }

    public static function handle_admin_post() {
        if (!is_admin() || !current_user_can('manage_woocommerce')) return;
        if (empty($_POST['ggw_action'])) return;
        if (empty($_POST['ggw_nonce']) || !wp_verify_nonce(sanitize_text_field(wp_unslash($_POST['ggw_nonce'])), self::NONCE_ACTION)) return;

        $action = sanitize_text_field(wp_unslash($_POST['ggw_action']));
        $campaigns = self::get_campaigns();

        if ($action === 'save_campaign') {
            $campaign_id = sanitize_text_field(wp_unslash($_POST['campaign_id'] ?? ''));
            $posted_chooser_mode = self::sanitize_gift_chooser_mode(wp_unslash($_POST['gift_chooser_mode'] ?? 'classic'));
            $posted_progressive_slides = self::parse_progressive_slides_post($_POST['progressive_slides'] ?? []);
            $posted_gift_products = self::csv_to_ids($_POST['gift_products_csv'] ?? '');
            $posted_gifts_to_choose = max(1, intval($_POST['gifts_to_choose'] ?? 1));
            $new = self::normalize_campaign([
                'id' => wp_generate_uuid4(),
                'title' => sanitize_text_field(wp_unslash($_POST['title'] ?? '')),
                'active' => !empty($_POST['active']),
                'priority' => intval($_POST['priority'] ?? 10),
                'start' => sanitize_text_field(wp_unslash($_POST['start'] ?? '')),
                'end' => sanitize_text_field(wp_unslash($_POST['end'] ?? '')),
                'trigger_products' => self::csv_to_ids($_POST['trigger_products_csv'] ?? ''),
                'trigger_categories' => self::csv_to_ids($_POST['trigger_categories_csv'] ?? ''),
                'trigger_tags' => self::csv_to_ids($_POST['trigger_tags_csv'] ?? ''),
                'min_qty' => intval($_POST['min_qty'] ?? 1),
                'min_subtotal' => floatval($_POST['min_subtotal'] ?? 0),
                'exclude_sale' => !empty($_POST['exclude_sale']),
                'gift_products' => $posted_gift_products,
                'gift_product_limits' => array_map('intval', (array) ($_POST['gift_product_limits'] ?? [])),
                'gifts_to_choose' => $posted_gifts_to_choose,
                'gift_chooser_mode' => $posted_chooser_mode,
                'progressive_slides' => $posted_progressive_slides,
                'max_gifts_per_order' => intval($_POST['max_gifts_per_order'] ?? 1),
                'max_per_customer' => intval($_POST['max_per_customer'] ?? 0),
                'require_choice' => !empty($_POST['require_choice']),
                'auto_gift' => !empty($_POST['auto_gift']),
                'headline' => sanitize_text_field(wp_unslash($_POST['headline'] ?? '')),
                'description' => sanitize_textarea_field(wp_unslash($_POST['description'] ?? '')),
                'badge' => sanitize_text_field(wp_unslash($_POST['badge'] ?? '')),
                'cta' => sanitize_text_field(wp_unslash($_POST['cta'] ?? '')),
                'gift_image_layout' => sanitize_key(wp_unslash($_POST['gift_image_layout'] ?? 'compact')),
                'gift_image_custom_min_width' => intval($_POST['gift_image_custom_min_width'] ?? 120),
                'gift_image_custom_aspect_ratio' => sanitize_text_field(wp_unslash($_POST['gift_image_custom_aspect_ratio'] ?? '1/1')),
                'gift_image_custom_max_grid_width' => intval($_POST['gift_image_custom_max_grid_width'] ?? 560),
                'gift_image_shape' => sanitize_key(wp_unslash($_POST['gift_image_shape'] ?? 'square')),
                'gift_image_custom_object_fit' => sanitize_key(wp_unslash($_POST['gift_image_custom_object_fit'] ?? 'cover')),
            ]);

            if (empty($new['title']) || empty($new['gift_products'])) {
                add_action('admin_notices', function(){ echo '<div class="notice notice-error"><p>Tittel og gaveprodukter er påkrevd.</p></div>'; });
                return;
            }

            if ($posted_chooser_mode === 'progressive') {
                $progressive_errors = self::validate_progressive_slides_input($posted_progressive_slides, $posted_gift_products, $posted_gifts_to_choose);
                if (!empty($progressive_errors)) {
                    add_action('admin_notices', function() use ($progressive_errors){
                        echo '<div class="notice notice-error"><p><strong>Kampanjen ble ikke lagret:</strong></p><ul style="list-style:disc;margin-left:20px;">';
                        foreach ($progressive_errors as $error_msg) {
                            echo '<li>' . esc_html($error_msg) . '</li>';
                        }
                        echo '</ul></div>';
                    });
                    return;
                }
            }

            if ($posted_chooser_mode === 'progressive' && $new['gift_chooser_mode'] !== 'progressive') {
                add_action('admin_notices', function(){ echo '<div class="notice notice-warning"><p>Progressiv gavemodus ble deaktivert fordi ingen gyldige slides var definert. Kampanjen ble lagret i klassisk modus.</p></div>'; });
            }

            $was_updated = false;
            if (!empty($campaign_id)) {
                foreach ($campaigns as $index => $campaign) {
                    if ($campaign['id'] !== $campaign_id) continue;
                    $new['id'] = $campaign_id;
                    $campaigns[$index] = $new;
                    $was_updated = true;
                    break;
                }
            }
            if (!$was_updated) {
                $campaigns[] = $new;
            }

            usort($campaigns, function($a, $b){
                return intval($b['priority']) <=> intval($a['priority']);
            });
            update_option(self::OPT_KEY, $campaigns, false);
            self::soft_invalidate_cache();
            wp_safe_redirect(admin_url('admin.php?page=ggw-free-gifts'));
            exit;
        }

        if ($action === 'toggle_campaign_active') {
            $id = sanitize_text_field(wp_unslash($_POST['id'] ?? ''));
            foreach ($campaigns as $index => $campaign) {
                if ($campaign['id'] !== $id) continue;
                $campaign['active'] = empty($campaign['active']) ? 1 : 0;
                $campaigns[$index] = self::normalize_campaign($campaign);
                break;
            }
            usort($campaigns, function($a, $b){
                return intval($b['priority']) <=> intval($a['priority']);
            });
            update_option(self::OPT_KEY, $campaigns, false);
            self::soft_invalidate_cache();
            wp_safe_redirect(admin_url('admin.php?page=ggw-free-gifts'));
            exit;
        }

        if ($action === 'delete_campaign') {
            $id = sanitize_text_field(wp_unslash($_POST['id'] ?? ''));
            $campaigns = array_values(array_filter($campaigns, function($c) use ($id){
                return $c['id'] !== $id;
            }));
            update_option(self::OPT_KEY, $campaigns, false);
            self::soft_invalidate_cache();
            wp_safe_redirect(admin_url('admin.php?page=ggw-free-gifts'));
            exit;
        }
    }

    private static function csv_to_ids($csv) {
        if (is_array($csv)) $csv = implode(',', $csv);
        $csv = sanitize_text_field(wp_unslash($csv));
        $parts = preg_split('/[,\s]+/', $csv);
        return array_values(array_filter(array_map('absint', (array)$parts)));
    }

    /* =========================
     * CAMPAIGN MATCHING
     * ========================= */
    private static function now_ts() {
        return current_time('timestamp');
    }

    private static function parse_admin_dt($str) {
        if (!$str) return 0;
        $ts = strtotime($str);
        return $ts ? $ts : 0;
    }

    private static function campaign_active_now($c) {
        if (empty($c['active'])) return false;
        $now = self::now_ts();
        $start = self::parse_admin_dt($c['start']);
        $end   = self::parse_admin_dt($c['end']);
        if ($start && $now < $start) return false;
        if ($end && $now > $end) return false;
        return true;
    }

    private static function product_parent_id($product_id) {
        $p = wc_get_product($product_id);
        if (!$p) return 0;
        if ($p->is_type('variation')) return $p->get_parent_id();
        return $p->get_id();
    }

    private static function product_match_trigger($product_id, $campaign) {
        $parent_id = self::product_parent_id($product_id);
        if (!$parent_id) return false;

        // Product IDs
        if (!empty($campaign['trigger_products']) && in_array($parent_id, $campaign['trigger_products'], true)) return true;

        // Categories
        if (!empty($campaign['trigger_categories'])) {
            $terms = wc_get_product_term_ids($parent_id, 'product_cat');
            if (array_intersect($terms, $campaign['trigger_categories'])) return true;
        }

        // Tags
        if (!empty($campaign['trigger_tags'])) {
            $terms = wc_get_product_term_ids($parent_id, 'product_tag');
            if (array_intersect($terms, $campaign['trigger_tags'])) return true;
        }

        return false;
    }

    public static function get_best_campaign_for_product($product_id) {
        $product_id = absint($product_id);
        if (!$product_id) return null;

        $last_changed = absint(get_option('ggw_campaigns_last_changed', 0));
        $cache_key = self::TRANSIENT_CAMPAIGN_BY_PRODUCT . $product_id . '_' . $last_changed;
        $cached = get_transient($cache_key);
        if ($cached !== false) return $cached ?: null;

        $match = null;
        $campaigns = self::get_campaigns();
        foreach ($campaigns as $c) {
            if (!self::campaign_active_now($c)) continue;
            if (self::product_match_trigger($product_id, $c)) {
                $match = $c;
                break; // already sorted by priority
            }
        }

        set_transient($cache_key, $match ?: 0, MINUTE_IN_SECONDS * 10);
        return $match;
    }

    private static function gift_product_is_available($gift_product_id) {
        $p = wc_get_product($gift_product_id);
        if (!$p || !$p->is_purchasable()) return false;
        if (!$p->is_in_stock()) return false;
        return true;
    }

    private static function first_available_gift($campaign) {
        foreach ($campaign['gift_products'] as $gid) {
            if (self::gift_product_is_available($gid)) return $gid;
        }
        return 0;
    }

    private static function get_available_gift_variations($gift_parent_id) {
        $gift_parent_id = absint($gift_parent_id);
        if (!$gift_parent_id) return [];

        $parent = wc_get_product($gift_parent_id);
        if (!$parent || !$parent->is_type('variable')) return [];

        $out = [];
        foreach ($parent->get_children() as $variation_id) {
            $variation = wc_get_product($variation_id);
            if (!$variation || !$variation->is_type('variation')) continue;
            if (!$variation->is_purchasable() || !$variation->is_in_stock()) continue;

            $attrs = $variation->get_variation_attributes();
            $label_parts = [];
            foreach ($attrs as $attr_key => $attr_value) {
                if ($attr_value === '') continue;
                $tax = str_replace('attribute_', '', (string)$attr_key);
                $name = wc_attribute_label($tax, $parent);
                if (taxonomy_exists($tax)) {
                    $term = get_term_by('slug', $attr_value, $tax);
                    $pretty = $term ? $term->name : $attr_value;
                } else {
                    $pretty = $attr_value;
                }
                $label_parts[] = trim($name . ': ' . $pretty);
            }

            $out[] = [
                'id' => $variation->get_id(),
                'attributes' => $attrs,
                'label' => !empty($label_parts) ? implode(', ', $label_parts) : sprintf(__('Alternativ %d', 'ggw'), $variation->get_id()),
            ];
        }

        return $out;
    }

    private static function get_first_valid_variation_for_gift($gift_parent_id) {
        $gift_parent_id = absint($gift_parent_id);
        if (!$gift_parent_id) return 0;

        $gift_parent = wc_get_product($gift_parent_id);
        if (!$gift_parent || !$gift_parent->is_type('variable')) return 0;

        $variations = self::get_available_gift_variations($gift_parent_id);
        foreach ($variations as $variation_row) {
            $candidate_variation_id = absint($variation_row['id'] ?? 0);
            if (!$candidate_variation_id) continue;
            if (self::validate_gift_choice([
                'gift_products' => [$gift_parent_id],
            ], $gift_parent_id, $candidate_variation_id)) {
                return $candidate_variation_id;
            }
        }

        return 0;
    }

    private static function validate_gift_choice($campaign, $gift_parent_id, $gift_variation_id = 0) {
        $gift_parent_id = absint($gift_parent_id);
        $gift_variation_id = absint($gift_variation_id);
        if (!$gift_parent_id) return false;
        if (!in_array($gift_parent_id, $campaign['gift_products'], true)) return false;

        $gift_parent = wc_get_product($gift_parent_id);
        if (!$gift_parent || !$gift_parent->is_purchasable() || !$gift_parent->is_in_stock()) return false;

        if ($gift_variation_id > 0) {
            $variation = wc_get_product($gift_variation_id);
            if (!$variation || !$variation->is_type('variation')) return false;
            if (intval($variation->get_parent_id()) !== $gift_parent_id) return false;
            if (!$variation->is_purchasable() || !$variation->is_in_stock()) return false;
        } else if ($gift_parent->is_type('variable')) {
            return false;
        }

        return true;
    }

    private static function campaign_allowed_gift_ids_for_slot($campaign, $slot_index) {
        $slot_index = max(0, intval($slot_index));
        $gift_ids = array_values(array_unique(array_map('absint', (array) ($campaign['gift_products'] ?? []))));
        if (empty($gift_ids)) {
            return [];
        }

        $chooser_mode = self::sanitize_gift_chooser_mode($campaign['gift_chooser_mode'] ?? 'classic');
        if ($chooser_mode !== 'progressive') {
            return $gift_ids;
        }

        $slides = array_values((array) ($campaign['progressive_slides'] ?? []));
        if (empty($slides)) {
            return $gift_ids;
        }

        $slide_index = $slot_index;
        if (!isset($slides[$slide_index])) {
            $slide_index = $slide_index % count($slides);
        }
        $slide_ids = array_values(array_unique(array_map('absint', (array) ($slides[$slide_index]['gift_ids'] ?? []))));
        if (empty($slide_ids)) {
            return [];
        }

        $gift_lookup = array_fill_keys($gift_ids, true);
        return array_values(array_filter($slide_ids, function($gift_id) use ($gift_lookup) {
            return !empty($gift_lookup[$gift_id]);
        }));
    }

    private static function get_variation_attributes_for_cart($gift_variation_id) {
        $gift_variation_id = absint($gift_variation_id);
        if (!$gift_variation_id) return [];

        $variation = wc_get_product($gift_variation_id);
        if (!$variation || !$variation->is_type('variation')) return [];
        return $variation->get_variation_attributes();
    }

    private static function campaign_by_id($campaign_id) {
        $campaign_id = sanitize_text_field((string) $campaign_id);
        if ($campaign_id === '') return null;

        foreach (self::get_campaigns() as $campaign) {
            if (($campaign['id'] ?? '') === $campaign_id) {
                return $campaign;
            }
        }

        return null;
    }

    private static function find_swap_choice_for_gift($campaign, $current_parent_id, $current_variation_id = 0, $slot_index = null) {
        $current_parent_id = absint($current_parent_id);
        $current_variation_id = absint($current_variation_id);

        $gift_ids = array_values(array_unique(array_map('absint', self::campaign_allowed_gift_ids_for_slot($campaign, $slot_index === null ? 0 : $slot_index))));
        if (empty($gift_ids)) return null;

        $start_index = 0;
        $current_index = array_search($current_parent_id, $gift_ids, true);
        if ($current_index !== false) {
            $start_index = intval($current_index) + 1;
        }

        $count = count($gift_ids);
        for ($step = 0; $step < $count; $step++) {
            $index = ($start_index + $step) % $count;
            $candidate_parent_id = absint($gift_ids[$index]);
            if (!$candidate_parent_id) continue;

            $candidate_variation_id = 0;
            $candidate_parent = wc_get_product($candidate_parent_id);
            if (!$candidate_parent) continue;

            if ($candidate_parent->is_type('variable')) {
                $candidate_variation_id = self::get_first_valid_variation_for_gift($candidate_parent_id);
                if (!$candidate_variation_id) continue;
            }

            if ($candidate_parent_id === $current_parent_id && $candidate_variation_id === $current_variation_id) {
                continue;
            }

            if (!self::validate_gift_choice($campaign, $candidate_parent_id, $candidate_variation_id)) {
                continue;
            }

            return [
                'gift_parent_id' => $candidate_parent_id,
                'gift_variation_id' => $candidate_variation_id,
            ];
        }

        return null;
    }

    private static function update_trigger_item_selection_after_swap($cart, $campaign_id, $old_parent_id, $old_variation_id, $new_parent_id, $new_variation_id, $slot_index = null) {
        if (!$cart || $cart->is_empty()) return;

        $campaign_id = sanitize_text_field((string) $campaign_id);
        $old_key = absint($old_parent_id) . ':' . absint($old_variation_id);
        $new_entry = [
            'gift_parent_id' => absint($new_parent_id),
            'gift_variation_id' => absint($new_variation_id),
        ];
        if ($slot_index !== null) {
            $new_entry['slot_index'] = max(0, intval($slot_index));
        }
        $updated = false;

        foreach ($cart->cart_contents as $item_key => $item) {
            if (self::cart_item_is_gift($item)) continue;
            if (($item['_ggw_campaign_id'] ?? '') !== $campaign_id) continue;

            $selected = $item['_ggw_selected_gifts'] ?? [];
            if (!is_array($selected)) $selected = [];

            $replaced_here = false;
            foreach ($selected as $idx => $selection) {
                $selection_key = absint($selection['gift_parent_id'] ?? 0) . ':' . absint($selection['gift_variation_id'] ?? 0);
                $selection_slot = isset($selection['slot_index']) ? max(0, intval($selection['slot_index'])) : null;
                if ($selection_key !== $old_key) continue;
                if ($slot_index !== null && $selection_slot !== max(0, intval($slot_index))) continue;
                $selected[$idx] = $new_entry;
                $replaced_here = true;
                $updated = true;
                break;
            }

            if (!$replaced_here && !$updated) {
                $selected[] = $new_entry;
                $updated = true;
            }

            if (!empty($selected)) {
                $cart->cart_contents[$item_key]['_ggw_selected_gifts'] = array_values($selected);
                $cart->cart_contents[$item_key]['_ggw_selected_gift'] = absint($selected[0]['gift_parent_id'] ?? 0);
                $cart->cart_contents[$item_key]['_ggw_selected_gift_variation'] = absint($selected[0]['gift_variation_id'] ?? 0);
            }

            if ($updated) {
                break;
            }
        }
    }


    private static function get_available_swap_choices_for_gift($campaign, $current_parent_id, $current_variation_id = 0, $cart = null, $exclude_cart_item_key = '', $slot_index = null) {
        $current_parent_id = absint($current_parent_id);
        $current_variation_id = absint($current_variation_id);
        $exclude_cart_item_key = sanitize_text_field((string) $exclude_cart_item_key);

        $gift_ids = array_values(array_unique(array_map('absint', self::campaign_allowed_gift_ids_for_slot($campaign, $slot_index === null ? 0 : $slot_index))));
        if (empty($gift_ids)) return [];

        $campaign_id = sanitize_text_field($campaign['id'] ?? '');
        $counts = [];
        if ($campaign_id !== '' && $cart && method_exists($cart, 'get_cart')) {
            foreach ($cart->get_cart() as $item_key => $item) {
                if ($exclude_cart_item_key !== '' && $item_key === $exclude_cart_item_key) continue;
                if (!self::cart_item_is_gift($item)) continue;
                if (($item['_ggw_campaign_id'] ?? '') !== $campaign_id) continue;
                $gift_parent_id = absint($item['product_id'] ?? 0);
                if (!$gift_parent_id) continue;
                $counts[$gift_parent_id] = ($counts[$gift_parent_id] ?? 0) + max(1, intval($item['quantity'] ?? 1));
            }
        }

        $slot_allowed = self::campaign_allowed_gift_ids_for_slot($campaign, $slot_index === null ? 0 : $slot_index);
        $slot_lookup = array_fill_keys(array_values(array_filter(array_map('absint', $slot_allowed))), true);

        $choices = [];
        foreach ($gift_ids as $candidate_parent_id) {
            if ($slot_index !== null && empty($slot_lookup[$candidate_parent_id])) continue;
            if (!$candidate_parent_id) continue;
            $candidate_parent = wc_get_product($candidate_parent_id);
            if (!$candidate_parent) continue;

            $limit = self::gift_limit_for_campaign_product($campaign, $candidate_parent_id);
            $already_used = max(0, intval($counts[$candidate_parent_id] ?? 0));
            if ($limit > 0 && $already_used >= $limit) {
                continue;
            }

            if ($candidate_parent->is_type('variable')) {
                $variation_choices = [];
                foreach (self::get_available_gift_variations($candidate_parent_id) as $variation_row) {
                    $candidate_variation_id = absint($variation_row['id'] ?? 0);
                    if (!$candidate_variation_id) continue;
                    if ($candidate_parent_id === $current_parent_id && $candidate_variation_id === $current_variation_id) {
                        continue;
                    }
                    if (!self::validate_gift_choice($campaign, $candidate_parent_id, $candidate_variation_id)) {
                        continue;
                    }

                    $variation_choices[] = [
                        'gift_variation_id' => $candidate_variation_id,
                        'label' => sanitize_text_field($variation_row['label'] ?? ''),
                    ];
                }

                if (empty($variation_choices)) {
                    continue;
                }

                $choices[] = [
                    'gift_parent_id' => $candidate_parent_id,
                    'gift_variation_id' => 0,
                    'product' => $candidate_parent,
                    'is_variable' => true,
                    'variation_choices' => $variation_choices,
                ];
                continue;
            }

            if ($candidate_parent_id === $current_parent_id && $current_variation_id === 0) {
                continue;
            }
            if (!self::validate_gift_choice($campaign, $candidate_parent_id, 0)) {
                continue;
            }

            $choices[] = [
                'gift_parent_id' => $candidate_parent_id,
                'gift_variation_id' => 0,
                'product' => $candidate_parent,
                'is_variable' => false,
                'variation_choices' => [],
            ];
        }

        return $choices;
    }

    private static function get_swap_gift_url($cart_item_key, $target_parent_id = 0, $target_variation_id = 0) {
        $args = [
            'ggw_action' => 'swap_gift',
            'ggw_gift_key' => sanitize_text_field((string) $cart_item_key),
        ];

        if ($target_parent_id) {
            $args['ggw_target_parent_id'] = absint($target_parent_id);
        }
        if ($target_variation_id) {
            $args['ggw_target_variation_id'] = absint($target_variation_id);
        }

        return wp_nonce_url(
            add_query_arg($args, wc_get_cart_url()),
            'ggw_swap_gift_' . sanitize_text_field((string) $cart_item_key)
        );
    }

    public static function maybe_handle_swap_gift_action() {
        if (empty($_GET['ggw_action']) || sanitize_text_field(wp_unslash($_GET['ggw_action'])) !== 'swap_gift') return;

        if (!function_exists('WC') || !WC() || !isset(WC()->cart)) {
            return;
        }

        $cart = WC()->cart;
        if (!$cart || $cart->is_empty() || !method_exists($cart, 'add_to_cart')) return;

        try {
            $gift_key = sanitize_text_field(wp_unslash($_GET['ggw_gift_key'] ?? ''));
            $nonce = sanitize_text_field(wp_unslash($_GET['_wpnonce'] ?? ''));
            if ($gift_key === '' || !$nonce || !wp_verify_nonce($nonce, 'ggw_swap_gift_' . $gift_key)) {
                wc_add_notice(__('Kunne ikke bytte gave. Ugyldig forespørsel.', 'ggw'), 'error');
                wp_safe_redirect(wc_get_cart_url());
                exit;
            }

            $cart_items = method_exists($cart, 'get_cart') ? $cart->get_cart() : (is_array($cart->cart_contents ?? null) ? $cart->cart_contents : []);
            $gift_item = $cart_items[$gift_key] ?? null;
            if (!$gift_item || !self::cart_item_is_gift($gift_item)) {
                wc_add_notice(__('Kunne ikke finne gave-linjen som skulle byttes.', 'ggw'), 'error');
                wp_safe_redirect(wc_get_cart_url());
                exit;
            }

            $campaign_id = sanitize_text_field($gift_item['_ggw_campaign_id'] ?? '');
            $campaign = self::campaign_by_id($campaign_id);
            if (!$campaign || !self::campaign_active_now($campaign)) {
                wc_add_notice(__('Kampanjen er ikke lenger aktiv for denne gaven.', 'ggw'), 'error');
                wp_safe_redirect(wc_get_cart_url());
                exit;
            }

            $current_parent_id = absint($gift_item['product_id'] ?? 0);
            $current_variation_id = absint($gift_item['variation_id'] ?? 0);
            $slot_index = isset($gift_item['_ggw_slot_index']) ? max(0, intval($gift_item['_ggw_slot_index'])) : null;

            $requested_parent_id = absint($_GET['ggw_target_parent_id'] ?? 0);
            $requested_variation_id = absint($_GET['ggw_target_variation_id'] ?? 0);

            if ($requested_parent_id > 0) {
                $new_parent_id = $requested_parent_id;
                $new_variation_id = $requested_variation_id;
            } else {
                $replacement = self::find_swap_choice_for_gift($campaign, $current_parent_id, $current_variation_id, $slot_index);
                if (!$replacement) {
                    wc_add_notice(__('Ingen andre tilgjengelige gavevalg akkurat nå.', 'ggw'), 'notice');
                    wp_safe_redirect(wc_get_cart_url());
                    exit;
                }

                $new_parent_id = absint($replacement['gift_parent_id'] ?? 0);
                $new_variation_id = absint($replacement['gift_variation_id'] ?? 0);
            }
            if (!self::validate_gift_choice($campaign, $new_parent_id, $new_variation_id)) {
                wc_add_notice(__('Valgt gave er ikke tilgjengelig lenger. Prøv igjen.', 'ggw'), 'error');
                wp_safe_redirect(wc_get_cart_url());
                exit;
            }
            $available_choices = self::get_available_swap_choices_for_gift($campaign, $current_parent_id, $current_variation_id, $cart, $gift_key, $slot_index);
            $choice_allowed = false;
            foreach ($available_choices as $choice) {
                if (absint($choice['gift_parent_id'] ?? 0) !== $new_parent_id) {
                    continue;
                }

                if (!empty($choice['is_variable'])) {
                    foreach (($choice['variation_choices'] ?? []) as $variation_choice) {
                        if (absint($variation_choice['gift_variation_id'] ?? 0) === $new_variation_id) {
                            $choice_allowed = true;
                            break 2;
                        }
                    }
                    continue;
                }

                if (absint($choice['gift_variation_id'] ?? 0) === $new_variation_id) {
                    $choice_allowed = true;
                    break;
                }
            }
            if (!$choice_allowed) {
                wc_add_notice(__('Valgt gave har nådd maks antall i kampanjen. Velg en annen gave.', 'ggw'), 'error');
                wp_safe_redirect(wc_get_cart_url());
                exit;
            }

            $variation_attributes = $new_variation_id ? self::get_variation_attributes_for_cart($new_variation_id) : [];
            $add_data = self::mark_cart_item_as_gift(
                [],
                $campaign_id,
                sanitize_text_field($gift_item['_ggw_trigger_key'] ?? ''),
                absint($gift_item['_ggw_trigger_product_id'] ?? 0),
                sanitize_text_field($gift_item['_ggw_label'] ?? 'Gratis gave'),
                $slot_index
            );

            $new_key = $cart->add_to_cart($new_parent_id, 1, $new_variation_id, $variation_attributes, $add_data);
            if (!$new_key) {
                wc_add_notice(__('Kunne ikke oppdatere gave-linjen. Prøv igjen.', 'ggw'), 'error');
                wp_safe_redirect(wc_get_cart_url());
                exit;
            }

            $new_item = $cart->cart_contents[$new_key] ?? null;
            if (isset($new_item['data']) && is_object($new_item['data']) && method_exists($new_item['data'], 'set_price')) {
                $new_item['data']->set_price(0);
            }
            $cart->set_quantity($new_key, 1, false);

            self::update_trigger_item_selection_after_swap($cart, $campaign_id, $current_parent_id, $current_variation_id, $new_parent_id, $new_variation_id, $slot_index);
            $cart->remove_cart_item($gift_key);
            $cart->calculate_totals();

            wc_add_notice(__('Gratis gave oppdatert i handlekurven.', 'ggw'), 'success');
            wp_safe_redirect(wc_get_cart_url());
            exit;
        } catch (\Throwable $e) {
            if (function_exists('wc_get_logger')) {
                wc_get_logger()->error(
                    'Swap gift failed: ' . $e->getMessage(),
                    ['source' => 'ggw-free-gift-campaigns', 'exception' => $e]
                );
            }
            wc_add_notice(__('Kunne ikke bytte gave akkurat nå. Prøv igjen.', 'ggw'), 'error');
            wp_safe_redirect(wc_get_cart_url());
            exit;
        }
    }

    /* =========================
     * PRODUCT PAGE UI
     * ========================= */
    public static function render_product_gift_ui() {
        global $product;
        if (!$product) return;

        $campaign = self::get_best_campaign_for_product($product->get_id());
        if (!$campaign) return;

        $gift_ids = array_values(array_filter($campaign['gift_products'], [__CLASS__, 'gift_product_is_available']));
        if (empty($gift_ids)) return;
        $gift_lookup = array_fill_keys($gift_ids, true);
        $chooser_mode = self::sanitize_gift_chooser_mode($campaign['gift_chooser_mode'] ?? 'classic');
        $progressive_slides = [];
        if ($chooser_mode === 'progressive') {
            foreach ((array) ($campaign['progressive_slides'] ?? []) as $slide) {
                if (!is_array($slide)) {
                    continue;
                }
                $slide_ids = [];
                foreach ((array) ($slide['gift_ids'] ?? []) as $candidate_id) {
                    $candidate_id = absint($candidate_id);
                    if (!$candidate_id || empty($gift_lookup[$candidate_id]) || in_array($candidate_id, $slide_ids, true)) {
                        continue;
                    }
                    $slide_ids[] = $candidate_id;
                }
                if (!empty($slide_ids)) {
                    $progressive_slides[] = ['gift_ids' => $slide_ids];
                }
            }
            if (empty($progressive_slides)) {
                $chooser_mode = 'classic';
            }
        }

        echo '<div class="ggw-box" style="margin:14px 0;padding:12px;border:1px solid #e5e7eb;border-radius:8px;background:#fafafa">';
        if (!empty($campaign['badge'])) {
            echo '<div style="display:inline-block;font-size:12px;font-weight:600;padding:3px 8px;border-radius:999px;background:#111;color:#fff;margin-bottom:8px;">' . esc_html($campaign['badge']) . '</div>';
        }
        echo '<div style="font-weight:600;margin-bottom:4px;">' . esc_html($campaign['headline']) . '</div>';
        if (!empty($campaign['description'])) {
            echo '<div style="font-size:13px;color:#4b5563;margin-bottom:8px;">' . esc_html($campaign['description']) . '</div>';
        }

        // If require choice, render gift grid with quantities.
        if (!empty($campaign['require_choice']) && empty($campaign['auto_gift'])) {
            $choice_slots = max(1, intval($campaign['gifts_to_choose'] ?? 1));
            if ($chooser_mode === 'progressive' && !empty($progressive_slides)) {
                $step_count = min(count($progressive_slides), $choice_slots);
                $gift_card_layout = self::get_gift_card_layout($campaign);
                $desktop_width = max(320, min(680, intval($gift_card_layout['max_grid_width'] ?? 560)));
                echo '<style>.ggw-progressive{max-width:min(100%,' . esc_attr($desktop_width) . 'px);margin:0 auto}.ggw-progressive-progress{text-align:center;font-size:13px;font-weight:600;margin-bottom:10px}.ggw-progressive-track{position:relative;overflow:hidden}.ggw-progressive-slide{position:absolute;left:0;top:0;width:100%;opacity:0;pointer-events:none;transform:translateX(18px);transition:transform .28s ease,opacity .28s ease}.ggw-progressive-slide.is-active{position:relative;opacity:1;pointer-events:auto;transform:translateX(0)}.ggw-progressive-cards{display:grid;gap:10px}.ggw-progressive-card{border:1px solid #d1d5db;border-radius:12px;padding:12px;background:#fff;cursor:pointer;transition:border-color .2s,box-shadow .2s}.ggw-progressive-card.is-selected{border-color:#111827;box-shadow:0 0 0 1px #111827 inset}.ggw-progressive-card:focus-visible{outline:2px solid #111827;outline-offset:2px}.ggw-progressive-row{display:flex;align-items:center;gap:10px}.ggw-progressive-media{width:72px;height:72px;flex:0 0 72px;border-radius:10px;overflow:hidden;background:#f3f4f6}.ggw-progressive-media img{width:100%;height:100%;object-fit:cover}.ggw-progressive-title{font-size:14px;font-weight:600}.ggw-progressive-var{display:none;margin-top:8px}.ggw-progressive-card.is-selected .ggw-progressive-var{display:block}.ggw-progressive-controls{display:flex;justify-content:space-between;gap:10px;margin-top:12px}.ggw-progressive-btn{min-height:44px;padding:10px 14px;border-radius:10px;border:1px solid #d1d5db;background:#fff;font-weight:600}.ggw-progressive-btn--next{background:#111827;color:#fff;border-color:#111827}.ggw-progressive-btn:disabled{opacity:.45}.ggw-progressive-error{min-height:18px;font-size:12px;color:#b91c1c;margin-top:8px}@media (min-width:768px){.ggw-progressive-progress{text-align:left}}</style>';
                echo '<div class="ggw-progressive" data-ggw-progressive data-steps="' . esc_attr($step_count) . '">';
                echo '<div class="ggw-progressive-progress" data-ggw-progressive-progress aria-live="polite"></div>';
                echo '<div class="ggw-progressive-track">';
                for ($step = 0; $step < $step_count; $step++) {
                    $slide_ids = array_values(array_filter(array_map('absint', (array) ($progressive_slides[$step]['gift_ids'] ?? []))));
                    if (empty($slide_ids)) continue;
                    echo '<section class="ggw-progressive-slide' . ($step === 0 ? ' is-active' : '') . '" data-ggw-progressive-slide data-step="' . esc_attr($step) . '" role="group" aria-label="Gavevalg ' . esc_attr($step + 1) . '">';
                    echo '<div class="ggw-progressive-cards" role="listbox">';
                    foreach ($slide_ids as $gid) {
                        $gp = wc_get_product($gid);
                        if (!$gp) continue;
                        $image_id = $gp->get_image_id();
                        $image_html = $image_id ? wp_get_attachment_image($image_id, 'woocommerce_thumbnail', false, ['loading' => 'lazy', 'decoding' => 'async']) : wc_placeholder_img('woocommerce_thumbnail');
                        echo '<article class="ggw-progressive-card" tabindex="0" role="option" aria-selected="false" data-ggw-card data-step="' . esc_attr($step) . '" data-gift-id="' . esc_attr($gid) . '">';
                        echo '<div class="ggw-progressive-row"><span class="ggw-progressive-media">' . wp_kses_post($image_html) . '</span><span class="ggw-progressive-title">' . esc_html($gp->get_name()) . '</span></div>';
                        if ($gp->is_type('variable')) {
                            $variations = self::get_available_gift_variations($gid);
                            if (!empty($variations)) {
                                echo '<div class="ggw-progressive-var"><label for="ggw_step_var_' . esc_attr($step) . '_' . esc_attr($gid) . '" style="display:block;font-size:12px;margin-bottom:4px;">Velg variant</label><select id="ggw_step_var_' . esc_attr($step) . '_' . esc_attr($gid) . '" data-ggw-var><option value="">Velg variant</option>';
                                foreach ($variations as $variation_row) {
                                    echo '<option value="' . esc_attr($variation_row['id']) . '">' . esc_html($variation_row['label']) . '</option>';
                                }
                                echo '</select></div>';
                            }
                        }
                        echo '</article>';
                    }
                    echo '</div></section>';
                }
                echo '</div><div class="ggw-progressive-controls"><button type="button" class="ggw-progressive-btn" data-ggw-back>Tilbake</button><button type="button" class="ggw-progressive-btn ggw-progressive-btn--next" data-ggw-next>Neste</button></div><div class="ggw-progressive-error" data-ggw-error aria-live="assertive"></div>';
                foreach ($gift_ids as $gid) {
                    echo '<input type="hidden" name="ggw_gift_qty[' . esc_attr($gid) . ']" value="0" data-ggw-hidden-qty data-gift-id="' . esc_attr($gid) . '">';
                    echo '<input type="hidden" name="ggw_gift_variation_id[' . esc_attr($gid) . ']" value="" data-ggw-hidden-var data-gift-id="' . esc_attr($gid) . '">';
                }
                for ($step = 0; $step < $step_count; $step++) {
                    echo '<input type="hidden" name="ggw_progressive_choice[' . esc_attr($step) . ']" value="" data-ggw-step-choice data-step="' . esc_attr($step) . '">';
                    echo '<input type="hidden" name="ggw_progressive_choice_variation[' . esc_attr($step) . ']" value="" data-ggw-step-var data-step="' . esc_attr($step) . '">';
                }
                echo '</div>';
                echo '<script>(function(){var root=document.querySelector("[data-ggw-progressive]");if(!root){return;}var slides=[].slice.call(root.querySelectorAll("[data-ggw-progressive-slide]"));var cards=[].slice.call(root.querySelectorAll("[data-ggw-card]"));if(!slides.length){return;}var back=root.querySelector("[data-ggw-back]");var next=root.querySelector("[data-ggw-next]");var progress=root.querySelector("[data-ggw-progressive-progress]");var error=root.querySelector("[data-ggw-error]");var qty=[].slice.call(root.querySelectorAll("[data-ggw-hidden-qty]"));var vars=[].slice.call(root.querySelectorAll("[data-ggw-hidden-var]"));var stepChoices=[].slice.call(root.querySelectorAll("[data-ggw-step-choice]"));var stepVars=[].slice.call(root.querySelectorAll("[data-ggw-step-var]"));var selected={};var current=0;var max=slides.length-1;var toInt=function(v){var n=parseInt(v,10);return isNaN(n)?0:n;};var getByStep=function(step){return cards.filter(function(c){return toInt(c.getAttribute("data-step"))===step;});};var setError=function(msg){if(error){error.textContent=msg||"";}};var syncHidden=function(){qty.forEach(function(i){i.value="0";});vars.forEach(function(i){i.value="";});stepChoices.forEach(function(i){i.value="";});stepVars.forEach(function(i){i.value="";});Object.keys(selected).forEach(function(k){var s=selected[k];var q=root.querySelector("[data-ggw-hidden-qty][data-gift-id=\""+s.giftId+"\"]");if(q){q.value="1";}var v=root.querySelector("[data-ggw-hidden-var][data-gift-id=\""+s.giftId+"\"]");if(v){v.value=s.variationId?String(s.variationId):"";}var c=root.querySelector("[data-ggw-step-choice][data-step=\""+k+"\"]");if(c){c.value=String(s.giftId);}var sv=root.querySelector("[data-ggw-step-var][data-step=\""+k+"\"]");if(sv){sv.value=s.variationId?String(s.variationId):"";}});};var paint=function(){slides.forEach(function(slide,idx){slide.classList.toggle("is-active",idx===current);});cards.forEach(function(card){var step=toInt(card.getAttribute("data-step"));var gift=toInt(card.getAttribute("data-gift-id"));var picked=selected[step]&&selected[step].giftId===gift;card.classList.toggle("is-selected",!!picked);card.setAttribute("aria-selected",picked?"true":"false");});if(progress){progress.textContent="Gave "+(current+1)+" av "+slides.length;}if(back){back.disabled=current===0;}if(next){next.textContent=current===max?"Ferdig":"Neste";}var focusEl=slides[current].querySelector(".ggw-progressive-card.is-selected")||slides[current].querySelector(".ggw-progressive-card");if(focusEl){window.requestAnimationFrame(function(){focusEl.focus();});}syncHidden();};var validate=function(step){if(!selected[step]){return "Velg en gave før du går videre.";}var card=root.querySelector("[data-ggw-card][data-step=\""+step+"\"][data-gift-id=\""+selected[step].giftId+"\"]");if(!card){return "Velg en gyldig gave.";}var select=card.querySelector("[data-ggw-var]");if(select&&String(select.value||"")===""){return "Velg variant før du går videre.";}return "";};cards.forEach(function(card){var pick=function(){var step=toInt(card.getAttribute("data-step"));var gift=toInt(card.getAttribute("data-gift-id"));var select=card.querySelector("[data-ggw-var]");selected[step]={giftId:gift,variationId:select?toInt(select.value):0};setError("");paint();};card.addEventListener("click",pick);card.addEventListener("keydown",function(e){if(e.key==="Enter"||e.key===" "){e.preventDefault();pick();}if(e.key==="ArrowRight"&&current<max){e.preventDefault();current++;paint();}if(e.key==="ArrowLeft"&&current>0){e.preventDefault();current--;paint();}});var select=card.querySelector("[data-ggw-var]");if(select){select.addEventListener("click",function(e){e.stopPropagation();});select.addEventListener("change",function(){var step=toInt(card.getAttribute("data-step"));if(selected[step]&&selected[step].giftId===toInt(card.getAttribute("data-gift-id"))){selected[step].variationId=toInt(select.value);syncHidden();}});}});if(back){back.addEventListener("click",function(){if(current>0){current--;setError("");paint();}});}if(next){next.addEventListener("click",function(){var problem=validate(current);if(problem){setError(problem);return;}if(current<max){current++;setError("");paint();}});}var form=root.closest("form.cart");if(form){form.addEventListener("submit",function(e){for(var idx=0;idx<=max;idx++){var issue=validate(idx);if(issue){e.preventDefault();current=idx;setError(issue);paint();return;}}setError("");});}paint();})();</script>';
                echo '<input type="hidden" name="ggw_campaign_id" value="' . esc_attr($campaign['id']) . '">';
                echo '<p style="font-size:12px;color:#6b7280;margin-top:6px;">Vi bekrefter gavevalget ditt i handlekurv og checkout.</p>';
                echo '</div>';
                return;
            }
            echo '<p style="font-size:12px;color:#374151;margin:0 0 8px;">Velg totalt <strong>' . intval($choice_slots) . '</strong> gave(r). Trykk <strong>+</strong> for å legge til og <strong>−</strong> for å fjerne.</p>';

            $gift_card_layout = self::get_gift_card_layout($campaign);
            $grid_min_width = max(80, intval($gift_card_layout['min_width'] ?? 120));
            $grid_max_width = max(320, intval($gift_card_layout['max_grid_width'] ?? 560));
            $card_aspect_ratio = self::sanitize_gift_image_aspect_ratio($gift_card_layout['aspect_ratio'] ?? '1/1');
            $card_object_fit = in_array($gift_card_layout['object_fit'] ?? 'cover', ['cover', 'contain'], true) ? $gift_card_layout['object_fit'] : 'cover';
            $card_shape = self::sanitize_gift_image_shape($gift_card_layout['shape'] ?? ($campaign['gift_image_shape'] ?? 'square'));
            $card_media_radius = $card_shape === 'round' ? '999px' : '8px';

            echo '<style>.ggw-gift-choice-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(' . esc_attr($grid_min_width) . 'px,1fr));gap:10px;max-width:min(100%,' . esc_attr($grid_max_width) . 'px);align-items:start}.ggw-gift-card{display:flex;flex-direction:column;position:relative;border:1px solid #d1d5db;border-radius:12px;padding:10px;background:#fff;transition:border-color .2s,box-shadow .2s;min-width:0;height:100%}.ggw-gift-card-media{width:100%;aspect-ratio:' . esc_attr($card_aspect_ratio) . ';border-radius:' . esc_attr($card_media_radius) . ';overflow:hidden;background:#f3f4f6;margin-bottom:8px;position:relative}.ggw-gift-card-media img{width:100%;height:100%;max-width:100%;object-fit:' . esc_attr($card_object_fit) . ';display:block}.ggw-gift-card-title{font-size:14px;line-height:1.35;color:#111827;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;word-break:break-word;min-height:38px}.ggw-gift-card.is-selected{border-color:#111827;box-shadow:0 0 0 1px #111827 inset}.ggw-gift-selected-overlay{position:absolute;top:8px;right:8px;background:#111827;color:#fff;border-radius:999px;font-size:11px;font-weight:600;padding:4px 8px;opacity:0;pointer-events:none;transform:translateY(-2px);transition:opacity .2s,transform .2s}.ggw-gift-card.is-selected .ggw-gift-selected-overlay{opacity:1;transform:translateY(0)}.ggw-gift-qty-row{margin-top:8px;display:flex;align-items:center;justify-content:space-between;gap:6px}.ggw-gift-qty-label{font-size:12px;color:#4b5563;font-weight:600}.ggw-gift-stepper{display:inline-flex;align-items:center;border:1px solid #d1d5db;border-radius:999px;overflow:hidden;background:#fff}.ggw-gift-stepper-btn{all:unset;width:34px;height:34px;display:inline-flex!important;align-items:center;justify-content:center;background:#fff!important;color:#111827!important;font-family:inherit!important;font-size:22px!important;font-weight:600!important;line-height:1!important;cursor:pointer;user-select:none}.ggw-gift-stepper-btn:hover{background:#f3f4f6!important}.ggw-gift-stepper-btn:focus-visible{outline:2px solid #111827;outline-offset:-2px}.ggw-gift-stepper-btn:disabled{opacity:.35!important;cursor:not-allowed}.ggw-gift-stepper-value{min-width:30px;text-align:center;font-size:16px;line-height:34px;font-weight:600;color:#111827}.ggw-gift-limit-note{margin-top:4px;font-size:11px;color:#b45309;display:none}.ggw-gift-limit-note.is-visible{display:block}.ggw-gift-variation-wrap{margin-top:8px}.ggw-gift-total{margin-top:10px;font-size:13px;color:#374151;font-weight:500}.ggw-gift-stepper-btn.is-blocked{opacity:.3!important;cursor:not-allowed}</style>';

            echo '<div class="ggw-gift-choice-grid">';
            foreach ($gift_ids as $gid) {
                $gp = wc_get_product($gid);
                if (!$gp) continue;

                $max_for_gift = self::get_per_product_limit_for_campaign($campaign, $gid);
                if ($max_for_gift <= 0) {
                    $max_for_gift = $choice_slots;
                }
                $max_for_gift = min($choice_slots, $max_for_gift);

                $image_id = $gp->get_image_id();
                $image_html = $image_id
                    ? wp_get_attachment_image($image_id, 'woocommerce_thumbnail', false, ['loading' => 'lazy', 'decoding' => 'async'])
                    : wc_placeholder_img('woocommerce_thumbnail');

                echo '<div class="ggw-gift-card" data-gift-id="' . esc_attr($gid) . '">';
                echo '<span class="ggw-gift-card-media">' . wp_kses_post($image_html) . '<span class="ggw-gift-selected-overlay" data-gift-overlay>' . esc_html__('Valgt x0', 'ggw') . '</span></span>';
                echo '<span class="ggw-gift-card-title">' . esc_html($gp->get_name()) . '</span>';
                echo '<div class="ggw-gift-qty-row">';
                echo '<span class="ggw-gift-qty-label">Antall</span>';
                echo '<div class="ggw-gift-stepper" data-gift-stepper data-gift-id="' . esc_attr($gid) . '">';
                echo '<button type="button" class="ggw-gift-stepper-btn" data-gift-minus aria-label="Reduser antall for ' . esc_attr($gp->get_name()) . '">−</button>';
                echo '<span class="ggw-gift-stepper-value" data-gift-value>0</span>';
                echo '<button type="button" class="ggw-gift-stepper-btn" data-gift-plus aria-label="Øk antall for ' . esc_attr($gp->get_name()) . '">+</button>';
                echo '</div>';
                echo '<input type="hidden" min="0" max="' . esc_attr($max_for_gift) . '" step="1" value="0" id="ggw_gift_qty_' . esc_attr($gid) . '" name="ggw_gift_qty[' . esc_attr($gid) . ']" data-gift-qty data-gift-id="' . esc_attr($gid) . '">';
                echo '</div>';
                echo '<small class="ggw-gift-limit-note" data-gift-limit-note aria-live="polite"></small>';

                if ($gp->is_type('variable')) {
                    $variations = self::get_available_gift_variations($gid);
                    if (!empty($variations)) {
                        echo '<div class="ggw-gift-variation-wrap" data-gift-id="' . esc_attr($gid) . '" style="display:none;">';
                        echo '<label for="ggw_gift_variation_' . esc_attr($gid) . '" style="display:block;font-size:12px;margin-bottom:4px;">Velg variant</label>';
                        echo '<select id="ggw_gift_variation_' . esc_attr($gid) . '" name="ggw_gift_variation_id[' . esc_attr($gid) . ']" style="width:100%;">';
                        echo '<option value="">Velg variant</option>';
                        foreach ($variations as $variation_row) {
                            echo '<option value="' . esc_attr($variation_row['id']) . '">' . esc_html($variation_row['label']) . '</option>';
                        }
                        echo '</select>';
                        echo '</div>';
                    }
                }

                echo '</div>';
            }
            echo '</div>';

            echo '<div class="ggw-gift-total" data-gift-total data-required="' . esc_attr($choice_slots) . '"></div>';

            echo '<script>(function(){var qtyInputs=document.querySelectorAll("[data-gift-qty]");if(!qtyInputs.length){return;}var totalEl=document.querySelector("[data-gift-total]");var parseIntSafe=function(v){var n=parseInt(v,10);return isNaN(n)?0:n;};var hideLimitNote=function(card){if(!card){return;}var note=card.querySelector("[data-gift-limit-note]");if(note){note.textContent="";note.classList.remove("is-visible");}};var showLimitNote=function(card,message){if(!card){return;}var note=card.querySelector("[data-gift-limit-note]");if(!note){return;}note.textContent=message;note.classList.add("is-visible");};var update=function(){var total=0;var required=totalEl?parseIntSafe(totalEl.getAttribute("data-required")):0;qtyInputs.forEach(function(input){var min=parseIntSafe(input.getAttribute("min"));var max=parseIntSafe(input.getAttribute("max"));var value=parseIntSafe(input.value);if(value<min){value=min;}if(max>0&&value>max){value=max;}input.value=value;total+=value;});qtyInputs.forEach(function(input){var min=parseIntSafe(input.getAttribute("min"));var value=parseIntSafe(input.value);var giftId=input.getAttribute("data-gift-id");var card=document.querySelector(".ggw-gift-card[data-gift-id=\""+giftId+"\"]");if(!card){return;}card.classList.toggle("is-selected",value>0);var valueEl=card.querySelector("[data-gift-value]");if(valueEl){valueEl.textContent=String(value);}var minusBtn=card.querySelector("[data-gift-minus]");if(minusBtn){minusBtn.disabled=value<=min;}var plusBtn=card.querySelector("[data-gift-plus]");if(plusBtn){var blocked=required>0&&total>=required&&value<=0;plusBtn.disabled=blocked;plusBtn.classList.toggle("is-blocked",blocked);}var overlay=card.querySelector("[data-gift-overlay]");if(overlay){overlay.textContent=value>0?"Valgt x"+value:"";}var variationWrap=card.querySelector(".ggw-gift-variation-wrap");if(variationWrap){variationWrap.style.display=value>0?"block":"none";if(value===0){var select=variationWrap.querySelector("select");if(select){select.selectedIndex=0;}}}});if(totalEl){if(total===required){totalEl.innerHTML="✅ Du har valgt riktig antall gaver ("+total+"/"+required+").";totalEl.style.color="#047857";}else if(total<required){totalEl.innerHTML="Velg "+(required-total)+" gave(r) til ("+total+"/"+required+").";totalEl.style.color="#374151";}else{totalEl.innerHTML="Du har valgt for mange gaver ("+total+"/"+required+"). Reduser antall før du legger i handlekurv.";totalEl.style.color="#b91c1c";}}};qtyInputs.forEach(function(input){var giftId=input.getAttribute("data-gift-id");var card=document.querySelector(".ggw-gift-card[data-gift-id=\""+giftId+"\"]");if(!card){return;}var plusBtn=card.querySelector("[data-gift-plus]");var minusBtn=card.querySelector("[data-gift-minus]");var step=function(delta){var min=parseIntSafe(input.getAttribute("min"));var max=parseIntSafe(input.getAttribute("max"));var value=parseIntSafe(input.value);var totalBefore=Array.prototype.reduce.call(qtyInputs,function(sum,el){return sum+parseIntSafe(el.value);},0);var required=totalEl?parseIntSafe(totalEl.getAttribute("data-required")):0;var next=value+delta;if(next<min){next=min;}if(delta>0&&max>0&&next>max){showLimitNote(card,"Du kan ikke velge mer enn "+max+" av denne gaven.");next=max;}else if(delta>0&&required>0&&totalBefore>=required){showLimitNote(card,"Du har allerede valgt maks antall gaver.");next=value;}else{hideLimitNote(card);}if(next!==value){input.value=String(next);}update();};if(plusBtn){plusBtn.addEventListener("click",function(){step(1);});}if(minusBtn){minusBtn.addEventListener("click",function(){step(-1);});}input.addEventListener("input",function(){hideLimitNote(card);update();});input.addEventListener("change",function(){hideLimitNote(card);update();});});update();})();</script>';

            echo '<input type="hidden" name="ggw_campaign_id" value="' . esc_attr($campaign['id']) . '">';
            echo '<p style="font-size:12px;color:#6b7280;margin-top:6px;">Vi bekrefter gavevalget ditt i handlekurv og checkout.</p>';
        } else {
            echo '<p style="font-size:13px;margin:0;">Gratis gave legges automatisk i handlekurven.</p>';
            echo '<input type="hidden" name="ggw_campaign_id" value="' . esc_attr($campaign['id']) . '">';
        }

        echo '</div>';
    }

    public static function validate_add_to_cart($passed, $product_id, $quantity, $variation_id = 0, $variations = []) {
        if (!$passed) return false;

        $requested_product = wc_get_product($product_id);
        if ($requested_product && $requested_product->is_type('variable') && !$variation_id) {
            wc_add_notice(__('You must choose a size for this product before adding it to the cart.', 'ggw'), 'error');
            return false;
        }

        $target_id = $variation_id ? $variation_id : $product_id;
        $campaign = self::get_best_campaign_for_product($target_id);
        if (!$campaign) return $passed;

        // Sale exclusion
        if (!empty($campaign['exclude_sale'])) {
            $p = wc_get_product($target_id);
            if ($p && $p->is_on_sale()) {
                wc_add_notice(__('Dette produktet gir ikke gratis gave fordi det er på salg.', 'ggw'), 'error');
                return false;
            }
        }

        // Required choice validation
        if (!empty($campaign['require_choice']) && empty($campaign['auto_gift'])) {
            $validation_error = '';
            $selected_gifts = self::collect_selected_gifts_from_request($campaign, WC()->cart, $validation_error);
            if ($selected_gifts === null) {
                wc_add_notice($validation_error ?: __('Velg gyldige gaver før du legger varen i handlekurven.', 'ggw'), 'error');
                return false;
            }
        }

        return $passed;
    }

    public static function capture_add_cart_data($cart_item_data, $product_id, $variation_id, $quantity) {
        $target_id = $variation_id ? $variation_id : $product_id;
        $campaign = self::get_best_campaign_for_product($target_id);
        if (!$campaign) return $cart_item_data;

        $cart_item_data['_ggw_campaign_id'] = $campaign['id'];
        $cart_item_data['_ggw_trigger_parent'] = self::product_parent_id($target_id);

        $selected_gifts = self::collect_selected_gifts_from_request($campaign, WC()->cart);

        if (!empty($selected_gifts)) {
            $cart_item_data['_ggw_selected_gifts'] = $selected_gifts;

            // Backward compatibility with old single-choice fields.
            $cart_item_data['_ggw_selected_gift'] = absint($selected_gifts[0]['gift_parent_id']);
            if (!empty($selected_gifts[0]['gift_variation_id'])) {
                $cart_item_data['_ggw_selected_gift_variation'] = absint($selected_gifts[0]['gift_variation_id']);
            }
        }
        return $cart_item_data;
    }

    private static function collect_selected_gifts_from_request($campaign, $cart = null, &$error = '') {
        $chooser_mode = self::sanitize_gift_chooser_mode($campaign['gift_chooser_mode'] ?? 'classic');
        if ($chooser_mode === 'progressive') {
            return self::collect_progressive_selected_gifts_from_request($campaign, $cart, $error);
        }

        return self::collect_classic_selected_gifts_from_request($campaign, $cart, $error);
    }

    private static function collect_classic_selected_gifts_from_request($campaign, $cart = null, &$error = '') {
        $required_count = max(1, intval($campaign['gifts_to_choose'] ?? 1));
        $posted_qty = $_POST['ggw_gift_qty'] ?? [];
        $gift_variation_map = $_POST['ggw_gift_variation_id'] ?? [];

        if (!is_array($posted_qty)) {
            $error = __('Velg antall gaver før du legger varen i handlekurven.', 'ggw');
            return null;
        }
        if (!is_array($gift_variation_map)) $gift_variation_map = [];

        $planned_counts = [];
        $selected_gifts = [];
        $total_selected = 0;

        foreach ($posted_qty as $gift_id_raw => $qty_raw) {
            $gift_id = absint($gift_id_raw);
            $qty = max(0, intval($qty_raw));
            if (!$gift_id || $qty < 1) continue;

            $max_for_gift = self::get_per_product_limit_for_campaign($campaign, $gift_id);
            if ($max_for_gift > 0) {
                $qty = min($qty, $max_for_gift);
            }

            $selected_variation = absint($gift_variation_map[$gift_id] ?? 0);
            $gift_product = wc_get_product($gift_id);
            if ($gift_product && $gift_product->is_type('variable') && !$selected_variation) {
                $error = sprintf(__('Velg variant for gave "%s" før du legger varen i handlekurven.', 'ggw'), $gift_product->get_name());
                return null;
            }

            if (!self::validate_gift_choice($campaign, $gift_id, $selected_variation)) {
                $error = sprintf(__('Gaven "%s" er ikke tilgjengelig nå. Velg en annen gave.', 'ggw'), get_the_title($gift_id));
                return null;
            }

            for ($i = 0; $i < $qty; $i++) {
                if (!self::gift_can_be_used_for_campaign($campaign, $gift_id, $cart ?: WC()->cart, $planned_counts)) {
                    $error = sprintf(__('Gaven "%s" har nådd maks antall for denne kampanjen.', 'ggw'), get_the_title($gift_id));
                    return null;
                }
                $planned_counts[$gift_id] = intval($planned_counts[$gift_id] ?? 0) + 1;
                $selected_gifts[] = [
                    'gift_parent_id' => $gift_id,
                    'gift_variation_id' => $selected_variation,
                ];
                $total_selected++;
            }
        }

        if ($total_selected !== $required_count) {
            $error = sprintf(__('Du må velge nøyaktig %d gave(r) før du legger varen i handlekurven.', 'ggw'), $required_count);
            return null;
        }

        return $selected_gifts;
    }

    private static function collect_progressive_selected_gifts_from_request($campaign, $cart = null, &$error = '') {
        $required_count = self::required_progressive_selection_count($campaign);
        $choices_by_step = $_POST['ggw_progressive_choice'] ?? [];
        $variation_by_step = $_POST['ggw_progressive_variation_id'] ?? ($_POST['ggw_progressive_choice_variation'] ?? []);

        if (!is_array($choices_by_step)) {
            $error = __('Velg gave i steg 1 før du legger varen i handlekurven.', 'ggw');
            return null;
        }
        if (!is_array($variation_by_step)) $variation_by_step = [];

        $selected_steps = [];
        foreach ($choices_by_step as $step_raw => $gift_id_raw) {
            $step = max(0, intval($step_raw));
            $gift_id = absint($gift_id_raw);
            if (!$gift_id) continue;
            $selected_steps[$step] = $gift_id;
        }

        ksort($selected_steps, SORT_NUMERIC);

        if (count($selected_steps) !== $required_count) {
            $error = sprintf(__('Du må velge nøyaktig %d gave(r) før du legger varen i handlekurven.', 'ggw'), $required_count);
            return null;
        }

        $selected_gifts = [];
        $planned_counts = [];

        for ($step = 0; $step < $required_count; $step++) {
            if (empty($selected_steps[$step])) {
                $error = sprintf(__('Velg gave i steg %d før du legger varen i handlekurven.', 'ggw'), $step + 1);
                return null;
            }

            $gift_id = absint($selected_steps[$step]);
            $selected_variation = absint($variation_by_step[$step] ?? 0);
            $gift_product = wc_get_product($gift_id);

            if ($gift_product && $gift_product->is_type('variable') && !$selected_variation) {
                $error = sprintf(__('Velg variant i steg %d før du legger varen i handlekurven.', 'ggw'), $step + 1);
                return null;
            }

            $allowed_step_gifts = self::campaign_allowed_gift_ids_for_slot($campaign, $step);
            if (!in_array($gift_id, $allowed_step_gifts, true) || !self::validate_gift_choice($campaign, $gift_id, $selected_variation)) {
                $error = sprintf(__('Valget i steg %d er ikke tilgjengelig nå. Velg en annen gave.', 'ggw'), $step + 1);
                return null;
            }

            if (!self::gift_can_be_used_for_campaign($campaign, $gift_id, $cart ?: WC()->cart, $planned_counts)) {
                $error = sprintf(__('Gaven i steg %d har nådd maks antall for denne kampanjen.', 'ggw'), $step + 1);
                return null;
            }

            $planned_counts[$gift_id] = intval($planned_counts[$gift_id] ?? 0) + 1;
            $selected_gifts[] = [
                'gift_parent_id' => $gift_id,
                'gift_variation_id' => $selected_variation,
                'slot_index' => $step,
            ];
        }

        if (count($selected_gifts) !== $required_count) {
            $error = sprintf(__('Du må velge nøyaktig %d gave(r) før du legger varen i handlekurven.', 'ggw'), $required_count);
            return null;
        }

        return $selected_gifts;
    }

    private static function required_progressive_selection_count($campaign) {
        $base_required = max(1, intval($campaign['gifts_to_choose'] ?? 1));
        $requested_qty = max(1, intval($_REQUEST['quantity'] ?? 1));
        $entitled_total = self::campaign_entitled_total($campaign, $requested_qty);
        if ($entitled_total > 0) {
            $base_required = $entitled_total;
        }

        return $base_required;
    }

    /* =========================
     * CART SYNC
     * ========================= */
    private static $session_loaded = false;
    public static function mark_session_loaded() { self::$session_loaded = true; }

    private static function get_customer_usage_identity() {
        if (is_user_logged_in()) {
            return [
                'type' => 'user',
                'value' => strval(get_current_user_id()),
            ];
        }

        $email = '';
        if (function_exists('WC') && WC() && WC()->customer) {
            $email = sanitize_email(WC()->customer->get_billing_email());
        }
        if (empty($email) && !empty($_POST['billing_email'])) {
            $email = sanitize_email(wp_unslash($_POST['billing_email']));
        }
        if (empty($email)) return null;

        return [
            'type' => 'email',
            'value' => strtolower($email),
        ];
    }

    private static function customer_used_count_for_campaign($campaign_id) {
        $identity = self::get_customer_usage_identity();
        if (empty($identity['type']) || empty($identity['value'])) return 0;

        $cache_version = absint(get_option(self::OPTION_USAGE_CACHE_VERSION, 1));
        $cache_key = 'ggw_used_' . $cache_version . '_' . md5($identity['type'] . '|' . $identity['value'] . '|' . $campaign_id);
        $cached = get_transient($cache_key);
        if ($cached !== false) return intval($cached);

        $count = 0;

        $args = [
            'status' => ['wc-processing', 'wc-completed', 'wc-on-hold'],
            'limit' => 100,
            'orderby' => 'date',
            'order' => 'DESC',
            'paginate' => true,
            'return' => 'ids',
        ];

        if ($identity['type'] === 'user') {
            $args['customer_id'] = absint($identity['value']);
        } else {
            $args['billing_email'] = $identity['value'];
        }

        $page = 1;
        do {
            $args['paged'] = $page;
            $orders_page = wc_get_orders($args);
            $order_ids = is_array($orders_page) ? $orders_page : ($orders_page->orders ?? []);

            foreach ($order_ids as $order_id) {
                $order = wc_get_order($order_id);
                if (!$order) continue;

                foreach ($order->get_items() as $it) {
                    if ($it->get_meta('_ggw_campaign_id') === $campaign_id && $it->get_meta('_ggw_is_gift') === '1') {
                        $count += max(1, intval($it->get_quantity()));
                    }
                }
            }

            $max_pages = is_array($orders_page) ? 0 : intval($orders_page->max_num_pages ?? 0);
            $page++;
        } while ($page <= $max_pages);

        set_transient($cache_key, $count, 5 * MINUTE_IN_SECONDS);
        return $count;
    }

    private static function campaign_rule_hits($campaign, $trigger_qty) {
        $min_qty = max(1, intval($campaign['min_qty'] ?? 1));
        $trigger_qty = max(0, intval($trigger_qty));
        if ($trigger_qty < $min_qty) return 0;
        return max(1, (int) floor($trigger_qty / $min_qty));
    }

    private static function campaign_entitled_total($campaign, $trigger_qty) {
        $rule_hits = self::campaign_rule_hits($campaign, $trigger_qty);
        if ($rule_hits < 1) return 0;

        $gifts_to_choose = max(1, intval($campaign['gifts_to_choose'] ?? 1));
        $max_gifts_per_order = max(1, intval($campaign['max_gifts_per_order'] ?? 1));
        return max(0, min($max_gifts_per_order, $rule_hits * $gifts_to_choose));
    }

    private static function get_campaign_gift_limits($campaign) {
        $limits = is_array($campaign['gift_product_limits'] ?? null) ? $campaign['gift_product_limits'] : [];
        $normalized = [];

        foreach ($limits as $gift_id => $max_qty) {
            $gift_id = absint($gift_id);
            if (!$gift_id) continue;
            $normalized[$gift_id] = max(0, intval($max_qty));
        }

        return $normalized;
    }

    private static function gift_limit_for_campaign_product($campaign, $gift_parent_id) {
        $gift_parent_id = absint($gift_parent_id);
        if (!$gift_parent_id) return 0;

        $limits = self::get_campaign_gift_limits($campaign);
        return max(0, intval($limits[$gift_parent_id] ?? 0));
    }

    private static function get_per_product_limit_for_campaign($campaign, $gift_parent_id) {
        return self::gift_limit_for_campaign_product($campaign, $gift_parent_id);
    }

    private static function gift_counts_for_campaign($cart, $campaign_id) {
        $counts = [];
        if (!$cart || $cart->is_empty()) return $counts;

        $campaign_id = sanitize_text_field((string) $campaign_id);
        if ($campaign_id === '') return $counts;

        foreach ($cart->get_cart() as $item) {
            if (!self::cart_item_is_gift($item)) continue;
            if (($item['_ggw_campaign_id'] ?? '') !== $campaign_id) continue;

            $gift_parent_id = absint($item['product_id'] ?? 0);
            if (!$gift_parent_id) continue;

            $counts[$gift_parent_id] = ($counts[$gift_parent_id] ?? 0) + max(1, intval($item['quantity'] ?? 1));
        }

        return $counts;
    }

    private static function gift_can_be_used_for_campaign($campaign, $gift_parent_id, $cart = null, $planned_counts = []) {
        $gift_parent_id = absint($gift_parent_id);
        if (!$gift_parent_id) return false;

        $limit = self::gift_limit_for_campaign_product($campaign, $gift_parent_id);
        if ($limit < 1) return true;

        $campaign_id = sanitize_text_field($campaign['id'] ?? '');
        $existing_count = 0;
        if ($campaign_id !== '' && $cart) {
            $existing_counts = self::gift_counts_for_campaign($cart, $campaign_id);
            $existing_count = intval($existing_counts[$gift_parent_id] ?? 0);
        }

        $planned = max(0, intval($planned_counts[$gift_parent_id] ?? 0));
        return ($existing_count + $planned) < $limit;
    }

    private static function apply_campaign_gift_limits_to_desired($campaign, $desired_gift_keys, $selected_map, $existing_counts = []) {
        $desired_gift_keys = is_array($desired_gift_keys) ? $desired_gift_keys : [];
        $selected_map = is_array($selected_map) ? $selected_map : [];
        $existing_counts = is_array($existing_counts) ? $existing_counts : [];

        $limits = self::get_campaign_gift_limits($campaign);
        if (empty($limits)) return $desired_gift_keys;

        $allowed = [];
        $planned_counts = [];

        foreach ($desired_gift_keys as $gift_key) {
            if (empty($selected_map[$gift_key])) continue;
            $gift_parent_id = absint($selected_map[$gift_key]['gift_parent_id'] ?? 0);
            if (!$gift_parent_id) continue;

            $limit = max(0, intval($limits[$gift_parent_id] ?? 0));
            if ($limit < 1) {
                $allowed[] = $gift_key;
                continue;
            }

            $already_in_cart = max(0, intval($existing_counts[$gift_parent_id] ?? 0));
            $planned = max(0, intval($planned_counts[$gift_parent_id] ?? 0));
            if (($already_in_cart + $planned) >= $limit) {
                continue;
            }

            $planned_counts[$gift_parent_id] = $planned + 1;
            $allowed[] = $gift_key;
        }

        return $allowed;
    }

    private static function cart_item_target_product_id($item) {
        return !empty($item['variation_id']) ? absint($item['variation_id']) : absint($item['product_id'] ?? 0);
    }

    private static function cart_item_counts_for_campaign_trigger($item, $campaign) {
        if (self::cart_item_is_gift($item)) return false;
        if (empty($campaign['exclude_sale'])) return true;

        $target_id = self::cart_item_target_product_id($item);
        if (!$target_id) return false;

        $product = wc_get_product($target_id);
        if (!$product) return false;

        return !$product->is_on_sale();
    }

    private static function cart_item_is_gift($item) {
        return !empty($item['_ggw_is_gift']);
    }

    private static function get_trigger_product_id_from_keys($cart, $trigger_keys) {
        if (!$cart || empty($trigger_keys) || !is_array($trigger_keys)) return 0;

        foreach ($trigger_keys as $trigger_key) {
            $trigger_key = strval($trigger_key);
            if ($trigger_key === '' || empty($cart->cart_contents[$trigger_key])) continue;

            $trigger_item = $cart->cart_contents[$trigger_key];
            $trigger_product_id = absint($trigger_item['product_id'] ?? 0);
            if ($trigger_product_id > 0) return $trigger_product_id;
        }

        return 0;
    }

    private static function mark_cart_item_as_gift($cart_item_data, $campaign_id = '', $trigger_key = '', $trigger_product_id = 0, $label = 'Gratis gave', $slot_index = null) {
        $cart_item_data['_ggw_is_gift'] = '1';
        $cart_item_data['_ggw_campaign_id'] = sanitize_text_field($campaign_id);
        $cart_item_data['_ggw_trigger_key'] = sanitize_text_field($trigger_key);
        $cart_item_data['_ggw_trigger_product_id'] = absint($trigger_product_id);
        $cart_item_data['_ggw_label'] = sanitize_text_field($label);
        $cart_item_data['_ggw_gift_instance'] = wp_generate_uuid4();
        if ($slot_index !== null) {
            $cart_item_data['_ggw_slot_index'] = max(0, intval($slot_index));
        }

        return $cart_item_data;
    }

    private static function should_exclude_gift_item_from_sums($cart_item, $context = 'default') {
        if (!self::cart_item_is_gift($cart_item)) return false;
        return (bool) apply_filters('ggw_exclude_gift_from_sum', true, $cart_item, $context);
    }

    private static function get_non_gift_cart_subtotal($cart) {
        if (!$cart || $cart->is_empty()) return 0.0;

        $subtotal = 0.0;
        foreach ($cart->get_cart() as $item) {
            if (self::should_exclude_gift_item_from_sums($item, 'subtotal')) continue;
            $subtotal += floatval($item['line_subtotal'] ?? 0);
        }
        return max(0.0, $subtotal);
    }

    public static function restore_gift_cart_item_data($session_data, $values) {
        if (!empty($session_data['_ggw_is_gift'])) {
            $session_data['_ggw_is_gift'] = '1';
        }
        if (isset($session_data['_ggw_slot_index'])) {
            $session_data['_ggw_slot_index'] = max(0, intval($session_data['_ggw_slot_index']));
        }
        return $session_data;
    }

    public static function filter_shipping_packages($packages) {
        if (empty($packages) || !is_array($packages)) return $packages;

        foreach ($packages as $idx => $package) {
            if (empty($package['contents']) || !is_array($package['contents'])) continue;

            $gift_total = 0.0;
            foreach ($package['contents'] as $item) {
                if (!self::should_exclude_gift_item_from_sums($item, 'shipping_package')) continue;
                $gift_total += floatval($item['line_total'] ?? $item['line_subtotal'] ?? 0);
            }

            if (!empty($gift_total) && isset($package['contents_cost'])) {
                $package['contents_cost'] = max(0.0, floatval($package['contents_cost']) - $gift_total);
            }

            $packages[$idx] = $package;
        }

        return $packages;
    }

    public static function filter_free_shipping_availability($is_available, $package, $shipping_method) {
        if (!is_object($shipping_method) || empty($shipping_method->min_amount)) return $is_available;

        $requires = $shipping_method->requires ?? '';
        if (!in_array($requires, ['min_amount', 'either', 'both'], true)) return $is_available;

        $cart = WC()->cart;
        if (!$cart) return $is_available;

        $non_gift_subtotal = self::get_non_gift_cart_subtotal($cart);
        if (in_array($requires, ['min_amount', 'either'], true) && $non_gift_subtotal < floatval($shipping_method->min_amount)) {
            return false;
        }

        if ($requires === 'both' && $non_gift_subtotal < floatval($shipping_method->min_amount)) {
            return false;
        }

        return $is_available;
    }

    public static function exclude_gifts_from_coupon_product_validation($valid, $product, $coupon, $values) {
        if (!self::cart_item_is_gift($values)) return $valid;

        if (self::should_exclude_gift_item_from_sums($values, 'coupon_validation')) {
            return false;
        }

        return $valid;
    }

    private static function coupon_priority_notice_text() {
        if (self::COUPON_GIFT_PRIORITY === 'gift_over_coupon') {
            return __('Prioritet: Gratis gave-regler gjelder først. Kuponger brukes ikke på gave-linjer.', 'ggw');
        }

        return __('Prioritet: Kuponger gjelder først. Gratis gave justeres deretter.', 'ggw');
    }

    private static function get_coupon_gift_conflict_reasons($cart = null) {
        if (!$cart && function_exists('WC') && WC()) {
            $cart = WC()->cart;
        }
        if (!$cart || $cart->is_empty()) return [];

        $gift_count = 0;
        foreach ($cart->get_cart() as $item) {
            if (!self::cart_item_is_gift($item)) continue;
            $gift_count += max(1, intval($item['quantity'] ?? 1));
        }
        if ($gift_count < 1) return [];

        $coupon_codes = array_values(array_filter(array_map('wc_clean', (array) $cart->get_applied_coupons())));
        if (empty($coupon_codes)) return [];

        return [[
            'type' => 'coupon_gift_priority',
            'message' => self::coupon_priority_notice_text(),
            'priority' => self::COUPON_GIFT_PRIORITY,
            'coupon_codes' => $coupon_codes,
            'gift_line_count' => $gift_count,
        ]];
    }

    private static function persist_coupon_gift_conflict_context($cart = null) {
        if (!function_exists('WC') || !WC() || !WC()->session) return;

        $reasons = self::get_coupon_gift_conflict_reasons($cart);
        if (empty($reasons)) {
            WC()->session->__unset('ggw_coupon_gift_conflicts');
            return;
        }

        WC()->session->set('ggw_coupon_gift_conflicts', $reasons);
    }

    private static function evaluate_campaign_trigger_state($campaign, $qty, $subtotal, $campaign_id = '') {
        $qty = max(0, intval($qty));
        $subtotal = max(0.0, floatval($subtotal));

        $missing_qty = max(0, intval($campaign['min_qty']) - $qty);
        $missing_subtotal = max(0.0, floatval($campaign['min_subtotal']) - $subtotal);

        if (!self::campaign_active_now($campaign)) {
            return ['qualifies' => false, 'entitled_total' => 0, 'missing_qty' => $missing_qty, 'missing_subtotal' => $missing_subtotal, 'blocked' => true];
        }

        if ($qty < intval($campaign['min_qty'])) {
            return ['qualifies' => false, 'entitled_total' => 0, 'missing_qty' => $missing_qty, 'missing_subtotal' => $missing_subtotal, 'blocked' => false];
        }

        if ($subtotal < floatval($campaign['min_subtotal'])) {
            return ['qualifies' => false, 'entitled_total' => 0, 'missing_qty' => $missing_qty, 'missing_subtotal' => $missing_subtotal, 'blocked' => false];
        }

        if (!empty($campaign['max_per_customer']) && $campaign_id !== '') {
            $used = self::customer_used_count_for_campaign($campaign_id);
            if ($used >= intval($campaign['max_per_customer'])) {
                return ['qualifies' => false, 'entitled_total' => 0, 'missing_qty' => 0, 'missing_subtotal' => 0.0, 'blocked' => true];
            }
        }

        $entitled_total = self::campaign_entitled_total($campaign, $qty);
        if ($entitled_total < 1) {
            return ['qualifies' => false, 'entitled_total' => 0, 'missing_qty' => 0, 'missing_subtotal' => 0.0, 'blocked' => true];
        }

        return ['qualifies' => true, 'entitled_total' => $entitled_total, 'missing_qty' => 0, 'missing_subtotal' => 0.0, 'blocked' => false];
    }

    private static function get_cart_campaign_status_rows() {
        $cart = WC()->cart;
        if (!$cart || $cart->is_empty()) return [];

        $rows = [];
        foreach ($cart->get_cart() as $item) {
            if (self::cart_item_is_gift($item)) continue;

            $pid = !empty($item['variation_id']) ? $item['variation_id'] : $item['product_id'];
            $campaign = self::get_best_campaign_for_product($pid);
            if (!$campaign) continue;

            if (!self::cart_item_counts_for_campaign_trigger($item, $campaign)) continue;

            $cid = $campaign['id'];
            if (!isset($rows[$cid])) {
                $rows[$cid] = [
                    'campaign' => $campaign,
                    'qty' => 0,
                    'subtotal' => 0.0,
                ];
            }

            $rows[$cid]['qty'] += intval($item['quantity'] ?? 0);
            $rows[$cid]['subtotal'] += floatval($item['line_subtotal'] ?? 0);
        }

        if (empty($rows)) return [];

        foreach ($rows as $cid => $row) {
            $rows[$cid]['trigger_state'] = self::evaluate_campaign_trigger_state($row['campaign'], $row['qty'], $row['subtotal'], $cid);
        }

        usort($rows, function($a, $b) {
            return intval($b['campaign']['priority']) <=> intval($a['campaign']['priority']);
        });

        return $rows;
    }

    public static function render_cart_status_line() {
        if (!function_exists('is_cart') || !is_cart()) return;

        self::persist_coupon_gift_conflict_context();

        $conflicts = self::get_coupon_gift_conflict_reasons();
        foreach ($conflicts as $conflict) {
            $coupon_codes = array_map('sanitize_text_field', (array) ($conflict['coupon_codes'] ?? []));
            $coupon_text = empty($coupon_codes) ? '' : ' (' . implode(', ', $coupon_codes) . ')';
            echo '<div class="ggw-cart-coupon-conflict" style="margin:0 0 12px;padding:10px 12px;border-radius:8px;background:#fffbeb;border:1px solid #f59e0b;color:#92400e;font-size:14px;font-weight:600;">';
            echo esc_html($conflict['message'] . $coupon_text);
            echo '</div>';
        }

        $rows = self::get_cart_campaign_status_rows();
        if (empty($rows)) return;

        $selected = null;
        foreach ($rows as $row) {
            if (empty($row['trigger_state']['blocked'])) {
                $selected = $row;
                break;
            }
        }
        if (!$selected) return;

        $trigger_state = $selected['trigger_state'];
        $campaign_title = sanitize_text_field($selected['campaign']['title'] ?? '');

        $message = '';
        $style = 'background:#f9fafb;border:1px solid #e5e7eb;color:#1f2937;';
        if (!empty($trigger_state['qualifies'])) {
            $message = 'Gratis gave er klar' . ($campaign_title ? ': ' . $campaign_title : '') . '.';
            $style = 'background:#f0fdf4;border:1px solid #86efac;color:#166534;';
        } else {
            $steps = [];
            $missing_qty = max(0, intval($trigger_state['missing_qty'] ?? 0));
            $missing_subtotal = max(0.0, floatval($trigger_state['missing_subtotal'] ?? 0.0));

            if ($missing_qty > 0) {
                $steps[] = 'legg til ' . $missing_qty . ' kvalifiserende vare' . ($missing_qty > 1 ? 'r' : '');
            }

            if ($missing_subtotal > 0.0) {
                $remaining_amount = wp_strip_all_tags(wc_price($missing_subtotal));
                $steps[] = 'mangler ' . $remaining_amount;
            }

            if (!empty($steps)) {
                $message = 'For å få gratis gave: ' . implode(' og ', $steps) . '.';
            }
        }

        if ($message === '') return;

        echo '<div class="ggw-cart-status-line" style="margin:0 0 16px;padding:10px 12px;border-radius:8px;font-size:14px;font-weight:600;' . esc_attr($style) . '">';
        echo esc_html($message);
        echo '</div>';
    }

    public static function sync_cart_gifts($cart) {
        if (is_admin() && !defined('DOING_AJAX')) return;
        if (!$cart || $cart->is_empty()) return;

        self::persist_coupon_gift_conflict_context($cart);

        // Prevent infinite loops
        static $running = false;
        if ($running) return;
        $running = true;

        $campaigns = self::get_campaigns();
        $campaign_index = [];
        foreach ($campaigns as $c) $campaign_index[$c['id']] = $c;

        $triggers = []; // campaign_id => info
        $gift_lines = []; // cart_item_key => item

        foreach ($cart->get_cart() as $key => $item) {
            if (self::cart_item_is_gift($item)) {
                $gift_lines[$key] = $item;
                continue;
            }

            $pid = !empty($item['variation_id']) ? $item['variation_id'] : $item['product_id'];
            $campaign = self::get_best_campaign_for_product($pid);
            if (!$campaign) continue;
            if (empty($campaign_index[$campaign['id']])) continue;

            if (!isset($triggers[$campaign['id']])) {
                $triggers[$campaign['id']] = [
                    'campaign' => $campaign,
                    'qty' => 0,
                    'subtotal' => 0.0,
                    'selected_gifts' => [],
                    'selected_gift_variations' => [],
                    'trigger_keys' => [],
                ];
            }

            $qty = intval($item['quantity']);
            $line_subtotal = isset($item['line_subtotal']) ? floatval($item['line_subtotal']) : 0.0;
            if (!self::cart_item_counts_for_campaign_trigger($item, $campaign)) continue;

            $triggers[$campaign['id']]['qty'] += $qty;
            $triggers[$campaign['id']]['subtotal'] += $line_subtotal;
            $triggers[$campaign['id']]['trigger_keys'][] = $key;

            $item_selected = $item['_ggw_selected_gifts'] ?? [];
            if (!is_array($item_selected) || empty($item_selected)) {
                if (!empty($item['_ggw_selected_gift'])) {
                    $item_selected = [[
                        'gift_parent_id' => absint($item['_ggw_selected_gift']),
                        'gift_variation_id' => absint($item['_ggw_selected_gift_variation'] ?? 0),
                    ]];
                } else {
                    $item_selected = [];
                }
            }

            foreach ($item_selected as $selection) {
                $gift_parent = absint($selection['gift_parent_id'] ?? 0);
                $gift_variation = absint($selection['gift_variation_id'] ?? 0);
                if (!self::validate_gift_choice($campaign, $gift_parent, $gift_variation)) continue;
                $selection_slot = isset($selection['slot_index']) ? max(0, intval($selection['slot_index'])) : null;
                $gift_key = $gift_parent . ':' . $gift_variation . ':' . ($selection_slot === null ? 'x' : $selection_slot);
                $triggers[$campaign['id']]['selected_gifts'][] = $gift_key;
                $triggers[$campaign['id']]['selected_gift_variations'][$gift_key] = [
                    'gift_parent_id' => $gift_parent,
                    'gift_variation_id' => $gift_variation,
                    'slot_index' => $selection_slot,
                ];
            }
        }

        $kept_gift_lines = [];

        // Evaluate entitlement and ensure gift lines
        foreach ($triggers as $cid => $info) {
            $c = $info['campaign'];

            $trigger_state = self::evaluate_campaign_trigger_state($c, $info['qty'], $info['subtotal'], $cid);
            if (empty($trigger_state['qualifies'])) continue;
            $entitled_total = intval($trigger_state['entitled_total']);

            $selected = array_values(array_unique($info['selected_gifts']));

            // auto-gift if needed
            if (empty($selected) && !empty($c['auto_gift'])) {
                $first = self::first_available_gift($c);
                if ($first) {
                    $auto_key = $first . ':0';
                    $selected[] = $auto_key;
                    $info['selected_gift_variations'][$auto_key] = [
                        'gift_parent_id' => $first,
                        'gift_variation_id' => 0,
                    ];
                }
            }

            // If still empty and required choice => wait for fallback in checkout/cart notice
            if (empty($selected)) continue;

            $desired = array_slice($selected, 0, $entitled_total);
            if (count($desired) < $entitled_total) {
                $selected_count = count($selected);
                for ($i = count($desired); $i < $entitled_total; $i++) {
                    $desired[] = $selected[$i % $selected_count];
                }
            }

            $desired = self::apply_campaign_gift_limits_to_desired($c, $desired, $info['selected_gift_variations']);

            foreach ($desired as $gift_key) {
                $gift_parent_id = absint($info['selected_gift_variations'][$gift_key]['gift_parent_id'] ?? 0);
                $gift_variation_id = absint($info['selected_gift_variations'][$gift_key]['gift_variation_id'] ?? 0);
                if (!self::validate_gift_choice($c, $gift_parent_id, $gift_variation_id)) continue;
                $variation_attributes = $gift_variation_id ? self::get_variation_attributes_for_cart($gift_variation_id) : [];

                $gift_slot_index = isset($info['selected_gift_variations'][$gift_key]['slot_index']) ? max(0, intval($info['selected_gift_variations'][$gift_key]['slot_index'])) : null;

                // Check if a matching gift line already exists for campaign + gift product
                $exists_key = null;
                foreach ($gift_lines as $gk => $gitem) {
                    if (($gitem['_ggw_campaign_id'] ?? '') === $cid
                        && empty($kept_gift_lines[$gk])
                        && intval($gitem['product_id']) === $gift_parent_id
                        && intval($gitem['variation_id'] ?? 0) === $gift_variation_id
                        && (($gift_slot_index === null && !isset($gitem['_ggw_slot_index'])) || ($gift_slot_index !== null && isset($gitem['_ggw_slot_index']) && max(0, intval($gitem['_ggw_slot_index'])) === $gift_slot_index))) {
                        $exists_key = $gk; break;
                    }
                }

                if ($exists_key) {
                    // enforce price 0 and qty 1
                    $gift_product = $cart->cart_contents[$exists_key]['data'];
                    if ($gift_product) $gift_product->set_price(0);
                    $cart->set_quantity($exists_key, 1, false);
                    $kept_gift_lines[$exists_key] = true;
                } else {
                    $trigger_ref = reset($info['trigger_keys']);
                    $trigger_product_id = self::get_trigger_product_id_from_keys($cart, $info['trigger_keys']);
                    $add_data = self::mark_cart_item_as_gift([], $cid, $trigger_ref ?: '', $trigger_product_id, 'Gratis gave', $gift_slot_index);
                    $new_key = $cart->add_to_cart($gift_parent_id, 1, $gift_variation_id, $variation_attributes, $add_data);
                    if ($new_key) {
                        if (isset($cart->cart_contents[$new_key]['data'])) {
                            $cart->cart_contents[$new_key]['data']->set_price(0);
                        }
                        $cart->set_quantity($new_key, 1, false);
                        $kept_gift_lines[$new_key] = true;
                    }
                }
            }
        }

        // Remove orphan / excess gifts and keep valid entitlement lines at qty 1
        foreach ($gift_lines as $gk => $gitem) {
            if (empty($kept_gift_lines[$gk])) {
                $cart->remove_cart_item($gk);
            } else {
                if (isset($cart->cart_contents[$gk]['data'])) {
                    $cart->cart_contents[$gk]['data']->set_price(0);
                }
                $cart->set_quantity($gk, 1, false);
            }
        }

        $running = false;
    }

    public static function cleanup_removed_trigger($cart_item_key, $cart) {
        // Safety cleanup done in sync_cart_gifts, this hook kept intentionally light.
    }

    public static function label_gift_cart_item($name, $cart_item, $cart_item_key) {
        if (self::cart_item_is_gift($cart_item)) {
            $name .= ' <small style="display:block;color:#16a34a;font-weight:600;">Gratis gave</small>';
            if (function_exists('is_cart') && is_cart()) {
                $campaign_id = sanitize_text_field($cart_item['_ggw_campaign_id'] ?? '');
                $campaign = self::campaign_by_id($campaign_id);
                $choices = $campaign ? self::get_available_swap_choices_for_gift(
                    $campaign,
                    absint($cart_item['product_id'] ?? 0),
                    absint($cart_item['variation_id'] ?? 0),
                    WC()->cart,
                    $cart_item_key,
                    isset($cart_item['_ggw_slot_index']) ? max(0, intval($cart_item['_ggw_slot_index'])) : null
                ) : [];

                if (!empty($choices)) {
                    $modal_id = 'ggw-swap-modal-' . sanitize_html_class($cart_item_key);
                    $name .= ' <small style="display:block;margin-top:6px;"><a href="#" class="ggw-open-swap-modal" data-ggw-modal-id="' . esc_attr($modal_id) . '">Bytt gave</a></small>';
                    $name .= '<div id="' . esc_attr($modal_id) . '" class="ggw-swap-modal" aria-hidden="true">';
                    $name .= '<div class="ggw-swap-modal__backdrop" data-ggw-modal-close></div>';
                    $name .= '<div class="ggw-swap-modal__panel" role="dialog" aria-modal="true" aria-label="Bytt gave">';
                    $name .= '<button type="button" class="ggw-swap-modal__close" data-ggw-modal-close aria-label="Lukk">×</button>';
                    $name .= '<h4 style="margin:0 0 8px;">Bytt gave</h4>';
                    $name .= '<p style="margin:0 0 10px;color:#4b5563;font-size:13px;">Velg en annen tilgjengelig gavekombinasjon.</p>';
                    $name .= '<ul style="margin:0;padding:0;list-style:none;display:grid;gap:8px;">';

                    foreach ($choices as $choice) {
                        $product = $choice['product'];
                        $target_parent_id = absint($choice['gift_parent_id'] ?? 0);
                        $target_variation_id = absint($choice['gift_variation_id'] ?? 0);
                        $label = $product ? $product->get_name() : __('Gavevalg', 'ggw');

                        if (!empty($choice['is_variable'])) {
                            $name .= '<li style="border:1px solid #e5e7eb;padding:8px;border-radius:8px;">';
                            $name .= '<div style="font-weight:600;margin-bottom:6px;">' . esc_html($label) . '</div>';
                            $name .= '<form method="get" action="' . esc_url(wc_get_cart_url()) . '" style="display:grid;gap:6px;">';
                            $name .= '<input type="hidden" name="ggw_action" value="swap_gift">';
                            $name .= '<input type="hidden" name="ggw_gift_key" value="' . esc_attr($cart_item_key) . '">';
                            $name .= '<input type="hidden" name="ggw_target_parent_id" value="' . esc_attr($target_parent_id) . '">';
                            $name .= '<input type="hidden" name="_wpnonce" value="' . esc_attr(wp_create_nonce('ggw_swap_gift_' . sanitize_text_field((string) $cart_item_key))) . '">';
                            $name .= '<select name="ggw_target_variation_id" required style="width:100%;">';
                            $name .= '<option value="">' . esc_html__('Velg variant', 'ggw') . '</option>';
                            foreach (($choice['variation_choices'] ?? []) as $variation_choice) {
                                $variation_id = absint($variation_choice['gift_variation_id'] ?? 0);
                                if (!$variation_id) continue;
                                $variation_label = sanitize_text_field($variation_choice['label'] ?? '');
                                $name .= '<option value="' . esc_attr($variation_id) . '">' . esc_html($variation_label) . '</option>';
                            }
                            $name .= '</select>';
                            $name .= '<button type="submit" class="button alt" style="width:100%;text-align:center;">' . esc_html__('Bytt til valgt variant', 'ggw') . '</button>';
                            $name .= '</form>';
                            $name .= '</li>';
                            continue;
                        }

                        $swap_url = self::get_swap_gift_url($cart_item_key, $target_parent_id, $target_variation_id);
                        $name .= '<li><a class="button alt" style="width:100%;text-align:center;" href="' . esc_url($swap_url) . '">' . esc_html($label) . '</a></li>';
                    }

                    $name .= '</ul>';
                    $name .= '</div>';
                    $name .= '</div>';
                }
            }

            return $name;
        }

        if (!empty($cart_item['_ggw_campaign_id'])) {
            $name .= ' <small style="display:block;margin-top:4px;color:#92400e;">Ved retur av hovedprodukt uten gratis gave(r), belastes gavene til full pris.</small>';
        }

        return $name;
    }


    public static function render_swap_gift_modal_assets() {
        if (!function_exists('is_cart') || !is_cart()) return;
        echo '<style>.ggw-swap-modal{position:fixed;inset:0;display:none;z-index:9999}.ggw-swap-modal.is-open{display:block}.ggw-swap-modal__backdrop{position:absolute;inset:0;background:rgba(17,24,39,.45)}.ggw-swap-modal__panel{position:relative;background:#fff;width:min(460px,92vw);margin:10vh auto 0;border-radius:12px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.2)}.ggw-swap-modal__close{position:absolute;top:8px;right:10px;border:0;background:transparent;font-size:24px;line-height:1;cursor:pointer;color:#6b7280}</style>';
        echo '<script>(function(){if(window.__ggwSwapModalReady){return;}window.__ggwSwapModalReady=true;document.addEventListener("click",function(e){var open=e.target.closest(".ggw-open-swap-modal");if(open){e.preventDefault();var id=open.getAttribute("data-ggw-modal-id");var modal=id?document.getElementById(id):null;if(modal){modal.classList.add("is-open");modal.setAttribute("aria-hidden","false");}return;}if(e.target.matches("[data-ggw-modal-close]")){var modal=e.target.closest(".ggw-swap-modal");if(modal){modal.classList.remove("is-open");modal.setAttribute("aria-hidden","true");}}});document.addEventListener("keydown",function(e){if(e.key!=="Escape"){return;}document.querySelectorAll(".ggw-swap-modal.is-open").forEach(function(modal){modal.classList.remove("is-open");modal.setAttribute("aria-hidden","true");});});})();</script>';
    }

    public static function display_cart_item_meta($item_data, $cart_item) {
        if (self::cart_item_is_gift($cart_item)) {
            return $item_data;
        }

        return $item_data;
    }

    /* =========================
     * CHECKOUT FALLBACK
     * ========================= */
    private static function campaigns_missing_gift_in_cart() {
        $cart = WC()->cart;
        if (!$cart || $cart->is_empty()) return [];

        $missing = [];
        $triggers_by_campaign = [];
        $gift_count_by_campaign = [];

        foreach ($cart->get_cart() as $cart_item_key => $item) {
            if (self::cart_item_is_gift($item)) {
                $cid = $item['_ggw_campaign_id'] ?? '';
                if ($cid) {
                    $gift_count_by_campaign[$cid] = ($gift_count_by_campaign[$cid] ?? 0) + max(1, intval($item['quantity'] ?? 1));
                }
                continue;
            }

            $pid = !empty($item['variation_id']) ? $item['variation_id'] : $item['product_id'];
            $c = self::get_best_campaign_for_product($pid);
            if (!$c) continue;
            if (!self::cart_item_counts_for_campaign_trigger($item, $c)) continue;

            if (!isset($triggers_by_campaign[$c['id']])) {
                $triggers_by_campaign[$c['id']] = ['campaign' => $c, 'qty' => 0, 'subtotal' => 0.0, 'trigger_keys' => []];
            }

            $triggers_by_campaign[$c['id']]['qty'] += intval($item['quantity']);
            $triggers_by_campaign[$c['id']]['subtotal'] += floatval($item['line_subtotal'] ?? 0);
            $triggers_by_campaign[$c['id']]['trigger_keys'][] = $cart_item_key;
        }

        foreach ($triggers_by_campaign as $cid => $row) {
            $c = $row['campaign'];
            $trigger_state = self::evaluate_campaign_trigger_state($c, $row['qty'], $row['subtotal'], $cid);
            if (empty($trigger_state['qualifies'])) continue;
            if (empty($c['require_choice']) || !empty($c['auto_gift'])) continue;

            $entitled_total = intval($trigger_state['entitled_total']);

            $gift_count = intval($gift_count_by_campaign[$cid] ?? 0);
            if ($gift_count >= $entitled_total) continue;

            $gifts = array_values(array_filter($c['gift_products'], [__CLASS__, 'gift_product_is_available']));
            if (empty($gifts)) continue;

            $gift_counts_for_campaign = self::gift_counts_for_campaign($cart, $cid);
            $gifts = array_values(array_filter($gifts, function($gift_id) use ($c, $gift_counts_for_campaign) {
                $limit = self::gift_limit_for_campaign_product($c, $gift_id);
                if ($limit < 1) return true;
                return intval($gift_counts_for_campaign[$gift_id] ?? 0) < $limit;
            }));
            if (empty($gifts)) continue;

            $missing_count = max(1, $entitled_total - $gift_count);
            $slot_gifts = [];
            for ($slot = 0; $slot < $missing_count; $slot++) {
                $allowed = self::campaign_allowed_gift_ids_for_slot($c, $slot);
                $slot_gifts[$slot] = array_values(array_filter($gifts, function($gift_id) use ($allowed) {
                    return in_array($gift_id, $allowed, true);
                }));
                if (empty($slot_gifts[$slot])) {
                    $slot_gifts[$slot] = $gifts;
                }
            }

            $missing[$cid] = [
                'campaign' => $c,
                'gifts' => $gifts,
                'slot_gifts' => $slot_gifts,
                'mode' => self::sanitize_gift_chooser_mode($c['gift_chooser_mode'] ?? 'classic'),
                'missing_count' => $missing_count,
                'trigger_key' => strval(reset($row['trigger_keys']) ?: ''),
                'trigger_product_id' => self::get_trigger_product_id_from_keys($cart, $row['trigger_keys']),
            ];
        }

        return $missing;
    }

    public static function render_checkout_fallback() {
        if (!is_checkout()) return;
        $missing = self::campaigns_missing_gift_in_cart();
        if (empty($missing)) return;

        echo '<div class="ggw-checkout-fallback" style="margin:16px 0;padding:12px;border:1px solid #e5e7eb;border-radius:8px;">';
        echo '<h3 style="margin-top:0">Velg din gratis gave</h3>';
        foreach ($missing as $cid => $row) {
            $c = $row['campaign'];
            $missing_count = max(1, intval($row['missing_count'] ?? 1));
            echo '<p style="margin:8px 0 4px;"><strong>' . esc_html($c['title']) . '</strong> (' . sprintf(esc_html__('%d gave(r) gjenstår', 'ggw'), $missing_count) . ')</p>';
            if (($row['mode'] ?? 'classic') === 'progressive') {
                echo '<p style="font-size:12px;color:#374151;margin:0 0 6px;">Fullfør gavevalg per steg for å fullføre kjøpet trygt.</p>';
            } else {
                echo '<p style="font-size:12px;color:#374151;margin:0 0 6px;">Velg ' . intval($missing_count) . ' gave(r) for å fullføre kjøpet trygt.</p>';
            }
            for ($slot = 0; $slot < $missing_count; $slot++) {
                $slot_number = $slot + 1;
                echo '<div class="ggw-checkout-choice-slot" style="margin:8px 0;padding:8px;border:1px dashed #e5e7eb;border-radius:6px;">';
                $slot_gifts = $row['slot_gifts'][$slot] ?? $row['gifts'];
                $slot_label = (($row['mode'] ?? 'classic') === 'progressive') ? ('Steg ' . intval($slot_number)) : ('Gavevalg ' . intval($slot_number));
                echo '<div style="font-size:12px;font-weight:600;margin-bottom:4px;">' . esc_html($slot_label) . '</div>';
                foreach ($slot_gifts as $gid) {
                    $gp = wc_get_product($gid);
                    if (!$gp) continue;
                    echo '<label style="display:block;margin:4px 0">';
                    echo '<input type="radio" name="ggw_checkout_gift[' . esc_attr($cid) . '][' . esc_attr($slot) . ']" value="' . esc_attr($gid) . '"> ';
                    echo esc_html($gp->get_name());
                    echo '</label>';

                    if ($gp->is_type('variable')) {
                        $variations = self::get_available_gift_variations($gid);
                        if (empty($variations)) continue;
                        echo '<div class="ggw-checkout-variation-wrap" data-campaign-id="' . esc_attr($cid) . '" data-slot="' . esc_attr($slot) . '" data-gift-id="' . esc_attr($gid) . '" style="display:none;margin:4px 0 8px 24px;">';
                        echo '<select name="ggw_checkout_gift_variation[' . esc_attr($cid) . '][' . esc_attr($slot) . '][' . esc_attr($gid) . ']" style="max-width:320px;">';
                        echo '<option value="">Velg variant</option>';
                        foreach ($variations as $variation_row) {
                            echo '<option value="' . esc_attr($variation_row['id']) . '">' . esc_html($variation_row['label']) . '</option>';
                        }
                        echo '</select>';
                        echo '</div>';
                    }
                }
                echo '</div>';
            }
        }
        echo '<script>(function(){var radios=document.querySelectorAll("input[name^=\"ggw_checkout_gift\"]");var wraps=document.querySelectorAll(".ggw-checkout-variation-wrap");if(!radios.length||!wraps.length){return;}var update=function(){wraps.forEach(function(w){var cid=w.getAttribute("data-campaign-id");var slot=w.getAttribute("data-slot");var gid=w.getAttribute("data-gift-id");var active=document.querySelector("input[name=\"ggw_checkout_gift["+cid+"]["+slot+"]\"][value=\""+gid+"\"]");w.style.display=(active&&active.checked)?"block":"none";});};radios.forEach(function(r){r.addEventListener("change",update);});update();})();</script>';
        echo '</div>';
    }

    public static function checkout_validate_fallback_choice() {
        $missing = self::campaigns_missing_gift_in_cart();
        if (empty($missing)) return;

        $posted = $_POST['ggw_checkout_gift'] ?? [];
        $posted_variations = $_POST['ggw_checkout_gift_variation'] ?? [];
        if (!is_array($posted)) $posted = [];
        if (!is_array($posted_variations)) $posted_variations = [];

        foreach ($missing as $cid => $row) {
            $required = max(1, intval($row['missing_count'] ?? 1));
            $planned_counts = [];
            for ($slot = 0; $slot < $required; $slot++) {
                $gift = absint($posted[$cid][$slot] ?? 0);
                $slot_variations = $posted_variations[$cid][$slot] ?? [];
                if (!is_array($slot_variations)) $slot_variations = [];
                $gift_variation = absint($slot_variations[$gift] ?? 0);
                if (!$gift) {
                    wc_add_notice(sprintf(__('Velg gave %d før du fullfører kjøpet.', 'ggw'), $slot + 1), 'error');
                    continue;
                }
                $slot_gifts = $row['slot_gifts'][$slot] ?? $row['gifts'];
                if (!in_array($gift, $slot_gifts, true)) {
                    wc_add_notice(__('Valgt gave er ikke tilgjengelig nå. Velg på nytt.', 'ggw'), 'error');
                    continue;
                }
                if (!self::validate_gift_choice($row['campaign'], $gift, $gift_variation)) {
                    wc_add_notice(__('Valgt variant er ikke tilgjengelig nå. Velg på nytt.', 'ggw'), 'error');
                    continue;
                }
                if (!self::gift_can_be_used_for_campaign($row['campaign'], $gift, WC()->cart, $planned_counts)) {
                    wc_add_notice(__('Valgt gave har nådd maks antall i kampanjen. Velg en annen gave.', 'ggw'), 'error');
                    continue;
                }
                $planned_counts[$gift] = intval($planned_counts[$gift] ?? 0) + 1;
            }
        }
    }

    public static function checkout_apply_fallback_choice() {
        $posted = $_POST['ggw_checkout_gift'] ?? [];
        $posted_variations = $_POST['ggw_checkout_gift_variation'] ?? [];
        $missing = self::campaigns_missing_gift_in_cart();
        if (!is_array($posted) || empty($posted) || empty($missing)) return;
        if (!is_array($posted_variations)) $posted_variations = [];

        $cart = WC()->cart;
        $existing_gifts = [];
        if ($cart && !$cart->is_empty()) {
            foreach ($cart->get_cart() as $item) {
                if (!self::cart_item_is_gift($item)) continue;
                $existing_gifts[] = [
                    'campaign_id' => sanitize_text_field($item['_ggw_campaign_id'] ?? ''),
                    'gift_parent_id' => absint($item['product_id'] ?? 0),
                    'gift_variation_id' => absint($item['variation_id'] ?? 0),
                ];
            }
        }

        $human = [];
        $stored = [];
        $added_any = false;
        foreach ($posted as $cid => $choices) {
            $cid = sanitize_text_field($cid);
            if (!$cid || empty($missing[$cid])) continue;
            if (!is_array($choices)) $choices = [$choices];
            $row = $missing[$cid];
            $required = max(1, intval($row['missing_count'] ?? 1));

            $selected_for_campaign = [];
            $planned_counts = [];
            for ($slot = 0; $slot < $required; $slot++) {
                $gift_parent_id = absint($choices[$slot] ?? 0);
                $slot_variations = $posted_variations[$cid][$slot] ?? [];
                if (!is_array($slot_variations)) $slot_variations = [];
                $gift_variation_id = absint($slot_variations[$gift_parent_id] ?? 0);
                if (!$gift_parent_id) continue;
                $slot_gifts = $row['slot_gifts'][$slot] ?? $row['gifts'];
                if (!in_array($gift_parent_id, $slot_gifts, true)) {
                    wc_add_notice(__('Valgt gave er ikke gyldig. Prøv igjen.', 'ggw'), 'error');
                    continue;
                }
                if (!self::validate_gift_choice($row['campaign'], $gift_parent_id, $gift_variation_id)) {
                    wc_add_notice(__('Valgt alternativ er ikke gyldig eller utsolgt. Prøv igjen.', 'ggw'), 'error');
                    continue;
                }
                if (!self::gift_can_be_used_for_campaign($row['campaign'], $gift_parent_id, $cart, $planned_counts)) {
                    wc_add_notice(__('Valgt gave har nådd maks antall i kampanjen. Velg en annen gave.', 'ggw'), 'error');
                    continue;
                }
                $planned_counts[$gift_parent_id] = intval($planned_counts[$gift_parent_id] ?? 0) + 1;
                $selected_for_campaign[] = [
                    'gift_parent_id' => $gift_parent_id,
                    'gift_variation_id' => $gift_variation_id,
                    'slot_index' => $slot,
                ];
            }

            $selected_count = count($selected_for_campaign);
            if ($selected_count < 1) continue;

            $to_add = max(0, intval($row['missing_count'] ?? 0));

            if ($to_add > 0 && $cart) {
                for ($i = 0; $i < $to_add; $i++) {
                    $choice = $selected_for_campaign[$i % $selected_count];
                    $gift_parent_id = absint($choice['gift_parent_id']);
                    $gift_variation_id = absint($choice['gift_variation_id']);
                    $variation_attributes = $gift_variation_id ? self::get_variation_attributes_for_cart($gift_variation_id) : [];

                    if (!self::validate_gift_choice($row['campaign'], $gift_parent_id, $gift_variation_id)) {
                        wc_add_notice(__('Valgt alternativ ble utsolgt i kassen. Velg på nytt.', 'ggw'), 'error');
                        break;
                    }

                    $add_data = self::mark_cart_item_as_gift(
                        [],
                        $cid,
                        sanitize_text_field($row['trigger_key'] ?? 'checkout_fallback'),
                        absint($row['trigger_product_id'] ?? 0),
                        'Gratis gave',
                        isset($choice['slot_index']) ? intval($choice['slot_index']) : null
                    );
                    $added_key = $cart->add_to_cart($gift_parent_id, 1, $gift_variation_id, $variation_attributes, $add_data);
                    if (!$added_key) {
                        wc_add_notice(__('Kunne ikke legge til gratis gave i handlekurven. Prøv igjen.', 'ggw'), 'error');
                        break;
                    }

                    if (isset($cart->cart_contents[$added_key]['data'])) {
                        $cart->cart_contents[$added_key]['data']->set_price(0);
                    }
                    $existing_gifts[] = [
                        'campaign_id' => $cid,
                        'gift_parent_id' => $gift_parent_id,
                        'gift_variation_id' => $gift_variation_id,
                    ];
                    $added_any = true;
                }
            }

            $stored[$cid] = [];
            foreach ($selected_for_campaign as $choice) {
                $gift_product = wc_get_product($choice['gift_variation_id'] ?: $choice['gift_parent_id']);
                $human[] = $cid . ': ' . ($gift_product ? $gift_product->get_name() : $choice['gift_parent_id']);
                $stored[$cid][] = [
                    'gift_parent_id' => absint($choice['gift_parent_id']),
                    'gift_variation_id' => absint($choice['gift_variation_id']),
                ];
            }
        }

        if ($added_any && $cart) {
            self::sync_cart_gifts($cart);
            $cart->calculate_totals();
        }

        if (!empty($human) && !empty($stored) && WC()->session) {
            WC()->session->set('ggw_checkout_selected_gifts', $stored);
            WC()->session->set('ggw_checkout_selected_gifts_human', $human);
        }
    }

    public static function checkout_audit_fallback_choice($order_id) {
        if (!$order_id || !WC()->session) return;

        $stored = WC()->session->get('ggw_checkout_selected_gifts');
        $human = WC()->session->get('ggw_checkout_selected_gifts_human');
        if (!is_array($stored) || empty($stored)) return;

        update_post_meta($order_id, '_ggw_checkout_selected_gifts', $stored);
        $order = wc_get_order($order_id);
        if ($order && is_array($human) && !empty($human)) {
            $order->add_order_note('Gratis gave valgt i kasse-fallback: ' . implode(' | ', $human));
        }

        WC()->session->__unset('ggw_checkout_selected_gifts');
        WC()->session->__unset('ggw_checkout_selected_gifts_human');
    }

    /* =========================
     * ORDER META
     * ========================= */
    public static function add_order_line_meta($item, $cart_item_key, $values, $order) {
        if (self::cart_item_is_gift($values)) {
            $item->add_meta_data('_ggw_is_gift', '1', true);
            $item->add_meta_data('_ggw_campaign_id', sanitize_text_field($values['_ggw_campaign_id'] ?? ''), true);
            $item->add_meta_data('_ggw_trigger_key', sanitize_text_field($values['_ggw_trigger_key'] ?? ''), true);
            $item->add_meta_data('_ggw_trigger_product_id', absint($values['_ggw_trigger_product_id'] ?? 0), true);
            $item->add_meta_data('Trigger-produkt (ID)', absint($values['_ggw_trigger_product_id'] ?? 0), true);
            $item->add_meta_data('Merking', 'Gratis gave', true);
        } else if (!empty($values['_ggw_campaign_id'])) {
            $item->add_meta_data('_ggw_trigger_campaign', sanitize_text_field($values['_ggw_campaign_id']), true);
            $item->add_meta_data('_ggw_trigger_parent', absint($values['_ggw_trigger_parent'] ?? 0), true);
        }
    }

    public static function add_order_coupon_conflict_meta($order, $data) {
        if (!function_exists('WC') || !WC() || !WC()->session || !$order) return;

        $reasons = WC()->session->get('ggw_coupon_gift_conflicts');
        if (!is_array($reasons) || empty($reasons)) {
            WC()->session->__unset('ggw_coupon_gift_conflicts');
            return;
        }

        $order->update_meta_data('_ggw_coupon_gift_conflicts', $reasons);

        $human = [];
        foreach ($reasons as $reason) {
            if (!is_array($reason)) continue;
            $coupon_codes = array_map('sanitize_text_field', (array) ($reason['coupon_codes'] ?? []));
            $coupon_text = empty($coupon_codes) ? '-' : implode(', ', $coupon_codes);
            $gift_count = max(0, intval($reason['gift_line_count'] ?? 0));
            $human[] = sprintf(
                'Kupong/gave-konflikt (%s): %s | kuponger: %s | gave-linjer: %d',
                sanitize_text_field($reason['priority'] ?? self::COUPON_GIFT_PRIORITY),
                sanitize_text_field($reason['message'] ?? ''),
                $coupon_text,
                $gift_count
            );
        }

        if (!empty($human)) {
            $order->add_order_note(implode(' || ', $human));
        }

        WC()->session->__unset('ggw_coupon_gift_conflicts');
    }

    /* =========================
     * CACHE INVALIDATION
     * ========================= */
    public static function soft_invalidate_cache() {
        update_option('ggw_campaigns_last_changed', current_time('timestamp', true), false);
        // Vi unngår tung sletting av alle transients; de utløper raskt (10 min).
    }

    public static function maybe_invalidate_usage_cache_on_status_change($order_id, $old_status, $new_status, $order) {
        $tracked_statuses = ['processing', 'completed', 'on-hold'];
        if (!in_array($new_status, $tracked_statuses, true)) return;
        self::invalidate_usage_cache_version();
    }

    private static function invalidate_usage_cache_version() {
        $version = absint(get_option(self::OPTION_USAGE_CACHE_VERSION, 1));
        update_option(self::OPTION_USAGE_CACHE_VERSION, $version + 1, false);
    }
}
endif;

GGW_Free_Gift_Campaigns::init();
